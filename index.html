<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Neon Survivor: Cyber Arena</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        let db, auth, userId;
        
        const initFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) return;
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        window.firebaseReady = true;
                    } else {
                        await signInAnonymously(auth);
                    }
                });
            } catch (e) { console.error("FB Error", e); }
        };

        window.firebaseObj = {
            init: initFirebase,
            db: () => db,
            getUserId: () => userId
        };
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #050505;
            overflow: hidden;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        #gameCanvas {
            background: #0a0a0f;
            image-rendering: pixelated;
        }

        /* Animations */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 10px #3b82f6; } 50% { box-shadow: 0 0 30px #3b82f6; } }
        @keyframes pop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .game-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; justify-content: center; align-items: center;
        }
        
        .pointer-auto { pointer-events: auto; }

        .card {
            background: rgba(17, 24, 39, 0.95);
            border: 1px solid #374151;
            transition: all 0.2s;
            cursor: pointer;
        }
        .card:hover {
            transform: translateY(-5px);
            border-color: #3b82f6;
            box-shadow: 0 10px 30px -10px rgba(59, 130, 246, 0.5);
        }

        .xp-bar-container {
            width: 100%; height: 6px; background: #1f2937; position: absolute; top: 0; left: 0;
        }
        .xp-bar-fill {
            height: 100%; background: linear-gradient(90deg, #3b82f6, #8b5cf6); width: 0%; transition: width 0.2s;
            box-shadow: 0 0 10px #3b82f6;
        }

        .damage-text {
            position: absolute; font-weight: bold; text-shadow: 0 0 2px black;
            animation: pop 0.2s ease-out forwards; pointer-events: none;
        }

        .joystick-area {
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
            width: 200px; height: 200px;
            /* border: 1px solid rgba(255,255,255,0.1); border-radius: 50%; */
            pointer-events: auto;
        }
    </style>
</head>
<body>

    <!-- HUD -->
    <div id="hud" class="hidden absolute top-0 left-0 w-full h-full pointer-events-none z-10">
        <div class="xp-bar-container"><div id="xpBar" class="xp-bar-fill"></div></div>
        
        <div class="absolute top-4 left-4 flex flex-col items-start">
            <div class="text-white font-black text-2xl drop-shadow-md">LVL <span id="lvlDisplay" class="text-yellow-400">1</span></div>
            <div class="text-gray-400 text-sm">â±ï¸ <span id="timeDisplay">00:00</span></div>
        </div>
        
        <div class="absolute top-4 right-4 text-right">
            <div class="text-green-400 font-bold text-xl">HP <span id="hpDisplay">100</span></div>
            <div class="text-yellow-400 text-sm">ğŸ’° <span id="goldDisplay">0</span></div>
        </div>
        
        <div class="absolute bottom-10 left-0 w-full text-center text-gray-500 text-xs">
            Ø§Ø³Ø­Ø¨ Ù„Ù„ØªØ­Ø±Ùƒ - Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠ
        </div>
    </div>

    <!-- Upgrade Screen (Pause) -->
    <div id="upgradeScreen" class="game-ui hidden z-50 bg-black/80 backdrop-blur-sm pointer-auto">
        <div class="flex flex-col items-center gap-6 w-full max-w-md p-4">
            <h2 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 animate-[float_2s_infinite]">LEVEL UP!</h2>
            <p class="text-gray-300">Ø§Ø®ØªØ± ØªØ±Ù‚ÙŠØ© ÙˆØ§Ø­Ø¯Ø©</p>
            <div id="upgradeCards" class="flex flex-col gap-3 w-full">
                <!-- Cards injected via JS -->
            </div>
        </div>
    </div>

    <!-- Main Menu -->
    <div id="mainMenu" class="game-ui z-40 bg-gray-900 pointer-auto flex-col">
        <h1 class="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-br from-cyan-400 to-blue-600 mb-2">NEON SURVIVOR</h1>
        <p class="text-gray-400 mb-8 tracking-widest">CYBER ARENA</p>
        
        <div class="bg-gray-800 p-4 rounded-xl mb-8 flex items-center gap-4 border border-gray-700">
            <div class="text-3xl">ğŸ’°</div>
            <div class="text-left">
                <div class="text-gray-400 text-xs">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø°Ù‡Ø¨</div>
                <div class="text-yellow-400 font-bold text-xl" id="menuGold">0</div>
            </div>
        </div>

        <div class="flex flex-col gap-3 w-64">
            <button id="btnStart" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-[0_0_20px_rgba(37,99,235,0.5)] transition-all active:scale-95">
                âš”ï¸ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø¹Ø±ÙƒØ©
            </button>
            <button id="btnShop" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-xl transition-all active:scale-95">
                ğŸ› ï¸ Ø§Ù„ØªØ·ÙˆÙŠØ±Ø§Øª
            </button>
        </div>
    </div>

    <!-- Permanent Shop -->
    <div id="shopScreen" class="game-ui hidden z-40 bg-gray-900 pointer-auto flex-col justify-start pt-10">
        <div class="flex justify-between items-center w-full max-w-md px-4 mb-6">
            <h2 class="text-3xl font-bold text-white">Ø§Ù„Ù…Ø®ØªØ¨Ø±</h2>
            <div class="text-yellow-400 font-bold" id="shopGold">0 ğŸ’°</div>
        </div>
        
        <div id="shopItems" class="grid grid-cols-1 gap-3 w-full max-w-md px-4 overflow-y-auto pb-20">
            <!-- Shop Items injected -->
        </div>

        <div class="absolute bottom-6 w-full max-w-md px-4">
            <button id="btnBack" class="w-full bg-red-600 text-white font-bold py-3 rounded-xl">Ø±Ø¬ÙˆØ¹</button>
        </div>
    </div>

    <!-- Game Over -->
    <div id="gameOverScreen" class="game-ui hidden z-50 bg-black/90 pointer-auto flex-col">
        <h2 class="text-5xl font-black text-red-500 mb-2">Ø§Ù„Ù‚Ø¶Ø§Ø¡ Ø¹Ù„ÙŠÙƒ</h2>
        <p class="text-gray-300 text-xl mb-6">ØµÙ…Ø¯Øª Ù„Ù…Ø¯Ø©: <span id="finalTime" class="text-white font-bold">00:00</span></p>
        
        <div class="grid grid-cols-2 gap-4 text-center mb-8 bg-gray-800 p-4 rounded-xl border border-gray-700">
            <div>
                <div class="text-gray-500 text-xs">Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡</div>
                <div class="text-white text-xl font-bold" id="finalKills">0</div>
            </div>
            <div>
                <div class="text-gray-500 text-xs">Ø§Ù„Ø°Ù‡Ø¨ Ø§Ù„Ù…ÙƒØªØ³Ø¨</div>
                <div class="text-yellow-400 text-xl font-bold" id="finalGold">0</div>
            </div>
        </div>

        <button id="btnRetry" class="bg-white text-black font-black py-3 px-10 rounded-full hover:scale-105 transition-transform">
            Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®Ø±Ù‰
        </button>
        <button id="btnHome" class="mt-4 text-gray-500 underline text-sm">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script type="module">
        import { doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Engine & Canvas ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let W, H;

        // --- Config ---
        const PERKS = [
            { id: 'multishot', name: 'Ù‚Ø°Ø§Ø¦Ù Ù…ØªØ¹Ø¯Ø¯Ø©', desc: 'ÙŠØ¶ÙŠÙ Ù‚Ø°ÙŠÙØ© Ø¥Ø¶Ø§ÙÙŠØ©', rarity: 'rare', color: '#3b82f6' },
            { id: 'firerate', name: 'Ø±Ø´Ø§Ø´ Ø³Ø±ÙŠØ¹', desc: 'Ø³Ø±Ø¹Ø© Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ +20%', rarity: 'common', color: '#ef4444' },
            { id: 'damage', name: 'Ø±ØµØ§Øµ Ø®Ø§Ø±Ù‚', desc: 'Ø§Ù„Ø¶Ø±Ø± +25%', rarity: 'common', color: '#f59e0b' },
            { id: 'speed', name: 'Ù…Ø­Ø±ÙƒØ§Øª Ù†ÙØ§Ø«Ø©', desc: 'Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ø±ÙƒØ© +15%', rarity: 'common', color: '#10b981' },
            { id: 'aura', name: 'Ø­Ù‚Ù„ ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ', desc: 'ÙŠØµØ¹Ù‚ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡ Ø§Ù„Ù‚Ø±ÙŠØ¨ÙŠÙ†', rarity: 'epic', color: '#8b5cf6' },
            { id: 'heal', name: 'Ø¥ØµÙ„Ø§Ø­ Ø°Ø§ØªÙŠ', desc: 'Ø§Ø³ØªØ¹Ø§Ø¯Ø© 30% Ù…Ù† Ø§Ù„ØµØ­Ø©', rarity: 'rare', color: '#ec4899' }
        ];

        const SHOP_UPGRADES = {
            baseDmg: { name: 'Ù‚ÙˆØ© Ø§Ù„Ø³Ù„Ø§Ø­', cost: (l) => (l+1)*100, max: 10, val: (l) => 10 + l*2 },
            maxHp: { name: 'Ø¯Ø±Ø¹ Ø§Ù„Ø¨Ø¯Ù†', cost: (l) => (l+1)*150, max: 10, val: (l) => 100 + l*20 },
            magnet: { name: 'Ù…ØºÙ†Ø§Ø·ÙŠØ³', cost: (l) => (l+1)*200, max: 5, val: (l) => 50 + l*20 }, // XP pickup range
            greed: { name: 'Ø§Ù„Ø¬Ø´Ø¹', cost: (l) => (l+1)*300, max: 5, val: (l) => 1 + l*0.2 }, // Gold multiplier
        };

        // --- Game State ---
        let state = {
            screen: 'MENU', // MENU, GAME, PAUSE, GAMEOVER, SHOP
            meta: { gold: 0, upgrades: { baseDmg: 0, maxHp: 0, magnet: 0, greed: 0 } },
            
            // Runtime
            time: 0,
            kills: 0,
            goldRun: 0,
            level: 1,
            xp: 0,
            xpNext: 100,
            
            // Player Runtime Stats (Base + In-game perks)
            stats: { 
                hp: 100, maxHp: 100, 
                dmg: 10, speed: 3, 
                fireRate: 400, projectiles: 1, 
                magnet: 50, hasAura: false 
            },

            // Entities
            enemies: [],
            bullets: [],
            gems: [], // XP & Gold
            particles: [],
            texts: [], // Damage numbers

            // Spawner
            wave: 1,
            nextSpawn: 0
        };

        // Global Player Object (Fixed Scope)
        let player = { x: 0, y: 0, vx: 0, vy: 0, angle: 0, lastShot: 0 };

        let lastTime = 0;
        let input = { x: 0, y: 0, active: false, startX: 0, startY: 0 };

        // --- Audio System ---
        let synth, membrane, metal;
        async function initAudio() {
            if (synth) return;
            await Tone.start();
            
            // Sound Effects
            synth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "triangle" },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 }
            }).toDestination();
            synth.volume.value = -10;

            membrane = new Tone.MembraneSynth().toDestination(); // Explosions
            membrane.volume.value = -15;

            metal = new Tone.MetalSynth({
                frequency: 200, envelope: { attack: 0.001, decay: 0.1, release: 0.01 },
                harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5
            }).toDestination(); // Pickup
            metal.volume.value = -20;
        }

        function playSfx(id) {
            if(!synth) return;
            if(id === 'shoot') synth.triggerAttackRelease("C5", "32n", undefined, 0.1);
            if(id === 'hit') synth.triggerAttackRelease("G2", "32n", undefined, 0.2);
            if(id === 'gem') metal.triggerAttackRelease("32n");
            if(id === 'lvlup') {
                const now = Tone.now();
                synth.triggerAttackRelease("C4", "8n", now);
                synth.triggerAttackRelease("E4", "8n", now + 0.1);
                synth.triggerAttackRelease("G4", "8n", now + 0.2);
            }
        }

        // --- Persistence ---
        function saveMeta() {
            if (!window.firebaseObj || !window.firebaseObj.getUserId()) {
                localStorage.setItem('neon_survivor_save', JSON.stringify(state.meta));
                return;
            }
            const ref = doc(window.firebaseObj.db(), `artifacts/${appId}/users/${window.firebaseObj.getUserId()}/data/survivor`);
            setDoc(ref, state.meta, { merge: true });
        }

        function loadMeta() {
            // Local fallback first
            const local = localStorage.getItem('neon_survivor_save');
            if(local) state.meta = JSON.parse(local);

            window.firebaseObj.init().then(() => {
                setTimeout(() => {
                    if (!window.firebaseObj.getUserId()) return;
                    const ref = doc(window.firebaseObj.db(), `artifacts/${appId}/users/${window.firebaseObj.getUserId()}/data/survivor`);
                    onSnapshot(ref, (snap) => {
                        if (snap.exists()) {
                            state.meta = snap.data();
                            updateMenuUI();
                        }
                    });
                }, 1000);
            });
            updateMenuUI();
        }

        // --- Core Logic ---
        function startRun() {
            // Apply meta upgrades to base stats
            const m = state.meta.upgrades;
            const shopDmg = SHOP_UPGRADES.baseDmg.val(m.baseDmg);
            const shopHp = SHOP_UPGRADES.maxHp.val(m.maxHp);
            const shopMag = SHOP_UPGRADES.magnet.val(m.magnet);

            state.stats = {
                hp: shopHp, maxHp: shopHp,
                dmg: shopDmg, speed: 3,
                fireRate: 500, projectiles: 1,
                magnet: shopMag, hasAura: false
            };
            
            state.level = 1;
            state.xp = 0;
            state.xpNext = 100;
            state.time = 0;
            state.kills = 0;
            state.goldRun = 0;
            state.enemies = [];
            state.bullets = [];
            state.gems = [];
            state.particles = [];
            state.texts = [];
            
            player.x = W/2; player.y = H/2;
            
            state.screen = 'GAME';
            toggleUI('hud');
            initAudio();
            loop(0);
        }

        function spawnEnemy() {
            const angle = Math.random() * Math.PI * 2;
            const dist = Math.max(W, H) / 1.5 + 50; // Spawn just outside screen
            const x = player.x + Math.cos(angle) * dist;
            const y = player.y + Math.sin(angle) * dist;
            
            // Difficulty Scaling
            const difficulty = 1 + state.time / 60; // Harder every minute
            
            let type = 'basic';
            if (state.time > 30 && Math.random() < 0.2) type = 'fast';
            if (state.time > 60 && Math.random() < 0.1) type = 'tank';

            let hp = 20 * difficulty;
            let speed = 1.5;
            let size = 15;
            let color = '#ef4444';

            if (type === 'fast') { speed = 2.5; hp *= 0.6; color = '#f59e0b'; }
            if (type === 'tank') { speed = 0.8; hp *= 3; size = 25; color = '#8b5cf6'; }

            state.enemies.push({ x, y, hp, maxHp: hp, speed, size, color, type });
        }

        function createGem(x, y, val, type='xp') {
            state.gems.push({ x, y, val, type });
        }

        function createText(x, y, text, color='#fff') {
            state.texts.push({ x, y, text, color, life: 1, vy: -1 });
        }

        function checkCollisions() {
            // Bullets vs Enemies
            for (let i = state.bullets.length - 1; i >= 0; i--) {
                const b = state.bullets[i];
                let hit = false;
                for (let e of state.enemies) {
                    const dx = b.x - e.x; const dy = b.y - e.y;
                    if (dx*dx + dy*dy < (e.size + 5)**2) {
                        e.hp -= state.stats.dmg;
                        createText(e.x, e.y, Math.floor(state.stats.dmg), '#fff');
                        playSfx('hit');
                        
                        // Knockback
                        const angle = Math.atan2(e.y - b.y, e.x - b.x);
                        e.x += Math.cos(angle) * 10;
                        e.y += Math.sin(angle) * 10;
                        
                        hit = true;
                        break;
                    }
                }
                if (hit) state.bullets.splice(i, 1);
            }

            // Enemies vs Player
            for (let e of state.enemies) {
                const dx = e.x - player.x; const dy = e.y - player.y;
                if (dx*dx + dy*dy < (e.size + 10)**2) {
                    state.stats.hp -= 0.5; // Damage over time contact
                    if (state.stats.hp <= 0) gameOver();
                }
            }
            
            // Player vs Gems (Magnet)
            for (let i = state.gems.length - 1; i >= 0; i--) {
                const g = state.gems[i];
                const dx = player.x - g.x; const dy = player.y - g.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist < state.stats.magnet) {
                    // Suck in
                    g.x += (dx / dist) * 8;
                    g.y += (dy / dist) * 8;
                }
                
                if (dist < 20) {
                    playSfx('gem');
                    if (g.type === 'xp') {
                        state.xp += g.val;
                        checkLevelUp();
                    } else {
                        const amount = Math.floor(g.val * SHOP_UPGRADES.greed.val(state.meta.upgrades.greed));
                        state.goldRun += amount;
                    }
                    state.gems.splice(i, 1);
                }
            }
        }

        function checkLevelUp() {
            if (state.xp >= state.xpNext) {
                state.xp -= state.xpNext;
                state.level++;
                state.xpNext = Math.floor(state.xpNext * 1.2);
                state.screen = 'PAUSE';
                playSfx('lvlup');
                showUpgradeScreen();
            }
        }

        function gameOver() {
            state.screen = 'GAMEOVER';
            state.meta.gold += state.goldRun;
            saveMeta();
            
            toggleUI('gameOverScreen');
            document.getElementById('finalTime').textContent = document.getElementById('timeDisplay').textContent;
            document.getElementById('finalKills').textContent = state.kills;
            document.getElementById('finalGold').textContent = state.goldRun;
        }

        // --- Render & Loop ---
        function loop(ts) {
            if (state.screen !== 'GAME') return;
            const dt = (ts - lastTime) / 1000;
            lastTime = ts;
            state.time += dt;

            // Update Input Movement
            if (input.active) {
                const len = Math.sqrt(input.x**2 + input.y**2);
                if (len > 0) {
                    player.x += (input.x / len) * state.stats.speed;
                    player.y += (input.y / len) * state.stats.speed;
                }
            }

            // Camera follow
            ctx.setTransform(1,0,0,1,0,0);
            ctx.clearRect(0, 0, W, H);
            
            // Center camera on player
            const camX = W/2 - player.x;
            const camY = H/2 - player.y;
            ctx.translate(camX, camY);

            // Draw Grid (World Ref)
            ctx.strokeStyle = '#1f2937';
            ctx.lineWidth = 2;
            const gridSize = 100;
            const startX = Math.floor((player.x - W/2)/gridSize)*gridSize;
            const startY = Math.floor((player.y - H/2)/gridSize)*gridSize;
            
            ctx.beginPath();
            for(let x=startX; x<startX+W+gridSize; x+=gridSize) { ctx.moveTo(x, player.y - H); ctx.lineTo(x, player.y + H); }
            for(let y=startY; y<startY+H+gridSize; y+=gridSize) { ctx.moveTo(player.x - W, y); ctx.lineTo(player.x + W, y); }
            ctx.stroke();

            // Entities Update & Draw
            // Gems
            state.gems.forEach(g => {
                ctx.fillStyle = g.type === 'xp' ? '#3b82f6' : '#fbbf24';
                ctx.shadowBlur = 10; ctx.shadowColor = ctx.fillStyle;
                ctx.beginPath(); ctx.rect(g.x-4, g.y-4, 8, 8); ctx.fill();
                ctx.shadowBlur = 0;
            });

            // Player
            ctx.fillStyle = '#fff';
            ctx.shadowBlur = 20; ctx.shadowColor = '#06b6d4';
            ctx.beginPath(); ctx.arc(player.x, player.y, 15, 0, Math.PI*2); ctx.fill();
            // Aura visual
            if(state.stats.hasAura) {
                ctx.strokeStyle = `rgba(139, 92, 246, ${0.3 + Math.sin(ts*0.01)*0.1})`;
                ctx.lineWidth = 2;
                ctx.beginPath(); ctx.arc(player.x, player.y, 100, 0, Math.PI*2); ctx.stroke();
            }
            ctx.shadowBlur = 0;

            // Auto Fire
            const now = Date.now();
            if (!player.lastShot) player.lastShot = 0;
            if (now - player.lastShot > (100000 / state.stats.fireRate) && state.enemies.length > 0) {
                // Find nearest
                let nearest = null; let minDst = Infinity;
                state.enemies.forEach(e => {
                    const d = (e.x-player.x)**2 + (e.y-player.y)**2;
                    if(d < minDst) { minDst = d; nearest = e; }
                });

                if (nearest) {
                    const angle = Math.atan2(nearest.y - player.y, nearest.x - player.x);
                    const count = state.stats.projectiles;
                    for(let i=0; i<count; i++) {
                        const spread = (i - (count-1)/2) * 0.2;
                        state.bullets.push({ 
                            x: player.x, y: player.y, 
                            vx: Math.cos(angle + spread) * 10, 
                            vy: Math.sin(angle + spread) * 10,
                            life: 100 
                        });
                    }
                    playSfx('shoot');
                    player.lastShot = now;
                }
            }

            // Aura Damage Logic
            if(state.stats.hasAura && ts % 20 < 1) { // Every ~20 frames
                state.enemies.forEach(e => {
                    const dist = Math.sqrt((e.x-player.x)**2 + (e.y-player.y)**2);
                    if(dist < 100) {
                        e.hp -= state.stats.dmg * 0.5;
                        createText(e.x, e.y, Math.floor(state.stats.dmg*0.5), '#8b5cf6');
                    }
                });
            }

            // Bullets
            ctx.fillStyle = '#67e8f9';
            state.bullets.forEach(b => {
                b.x += b.vx; b.y += b.vy; b.life--;
                ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, Math.PI*2); ctx.fill();
            });
            state.bullets = state.bullets.filter(b => b.life > 0);

            // Enemies
            state.enemies.forEach((e, i) => {
                // Move towards player
                const angle = Math.atan2(player.y - e.y, player.x - e.x);
                e.x += Math.cos(angle) * e.speed;
                e.y += Math.sin(angle) * e.speed;
                
                ctx.fillStyle = e.color;
                ctx.fillRect(e.x - e.size/2, e.y - e.size/2, e.size, e.size);
                
                // Death
                if (e.hp <= 0) {
                    createGem(e.x, e.y, 10 + (state.level*2), Math.random() > 0.9 ? 'gold' : 'xp');
                    state.kills++;
                    state.enemies.splice(i, 1);
                }
            });

            // Spawner
            if (now > state.nextSpawn) {
                spawnEnemy();
                const rate = Math.max(200, 1000 - (state.time * 5)); // Spawn faster over time
                state.nextSpawn = now + rate;
            }

            // Texts
            state.texts.forEach((t, i) => {
                t.y += t.vy; t.life -= 0.05;
                ctx.fillStyle = t.color;
                ctx.font = 'bold 16px Arial';
                ctx.globalAlpha = Math.max(0, t.life);
                ctx.fillText(t.text, t.x, t.y);
                ctx.globalAlpha = 1;
                if(t.life <= 0) state.texts.splice(i, 1);
            });

            checkCollisions();
            updateHUD();

            requestAnimationFrame(loop);
        }

        // --- UI & Interactions ---
        function updateHUD() {
            // HP
            document.getElementById('hpDisplay').innerText = Math.floor(state.stats.hp);
            // XP
            const pct = (state.xp / state.xpNext) * 100;
            document.getElementById('xpBar').style.width = `${pct}%`;
            // Level
            document.getElementById('lvlDisplay').innerText = state.level;
            // Gold
            document.getElementById('goldDisplay').innerText = state.goldRun;
            // Time
            const m = Math.floor(state.time / 60);
            const s = Math.floor(state.time % 60);
            document.getElementById('timeDisplay').innerText = `${m}:${s < 10 ? '0'+s : s}`;
        }

        function updateMenuUI() {
            document.getElementById('menuGold').innerText = state.meta.gold;
            document.getElementById('shopGold').innerText = state.meta.gold + " ğŸ’°";
        }

        function showUpgradeScreen() {
            toggleUI('upgradeScreen');
            const container = document.getElementById('upgradeCards');
            container.innerHTML = '';
            
            // Pick 3 random perks
            const opts = [];
            for(let i=0; i<3; i++) opts.push(PERKS[Math.floor(Math.random() * PERKS.length)]);
            
            opts.forEach(p => {
                const div = document.createElement('div');
                div.className = 'card w-full p-4 rounded-xl flex items-center justify-between';
                div.style.borderColor = p.color;
                div.innerHTML = `
                    <div>
                        <h3 class="font-bold text-white text-lg" style="color:${p.color}">${p.name}</h3>
                        <p class="text-sm text-gray-400">${p.desc}</p>
                    </div>
                    <button class="bg-gray-700 hover:bg-white hover:text-black text-white px-4 py-2 rounded-lg font-bold transition-colors">Ø§Ø®ØªØ±</button>
                `;
                div.onclick = () => applyPerk(p);
                container.appendChild(div);
            });
        }

        function applyPerk(p) {
            if (p.id === 'multishot') state.stats.projectiles++;
            if (p.id === 'firerate') state.stats.fireRate *= 0.8;
            if (p.id === 'damage') state.stats.dmg *= 1.25;
            if (p.id === 'speed') state.stats.speed *= 1.15;
            if (p.id === 'heal') state.stats.hp = Math.min(state.stats.maxHp, state.stats.hp + (state.stats.maxHp * 0.3));
            if (p.id === 'aura') state.stats.hasAura = true;

            state.screen = 'GAME';
            toggleUI('hud');
            loop(lastTime); // Resume
        }

        function toggleUI(screenId) {
            ['mainMenu', 'hud', 'upgradeScreen', 'gameOverScreen', 'shopScreen'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        function renderShop() {
            const list = document.getElementById('shopItems');
            list.innerHTML = '';
            
            Object.keys(SHOP_UPGRADES).forEach(key => {
                const item = SHOP_UPGRADES[key];
                const currentLvl = state.meta.upgrades[key];
                const cost = item.cost(currentLvl);
                const isMax = currentLvl >= item.max;

                const div = document.createElement('div');
                div.className = 'bg-gray-800 p-4 rounded-xl flex justify-between items-center';
                div.innerHTML = `
                    <div>
                        <div class="font-bold text-white">${item.name} <span class="text-blue-400 text-sm">Lv.${currentLvl}</span></div>
                        <div class="flex gap-1 mt-1">
                            ${Array(item.max).fill(0).map((_,i) => `<div class="w-2 h-2 rounded-full ${i < currentLvl ? 'bg-green-500' : 'bg-gray-600'}"></div>`).join('')}
                        </div>
                    </div>
                    <button class="px-4 py-2 rounded-lg font-bold ${state.meta.gold >= cost && !isMax ? 'bg-yellow-600 hover:bg-yellow-500 text-black' : 'bg-gray-700 text-gray-500 cursor-not-allowed'}">
                        ${isMax ? 'MAX' : cost + 'ğŸ’°'}
                    </button>
                `;
                if(state.meta.gold >= cost && !isMax) {
                    div.querySelector('button').onclick = () => {
                        state.meta.gold -= cost;
                        state.meta.upgrades[key]++;
                        saveMeta();
                        updateMenuUI();
                        renderShop();
                    };
                }
                list.appendChild(div);
            });
        }

        // --- Inputs ---
        function resizeCanvas() { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; }
        
        window.addEventListener('resize', resizeCanvas);
        
        // Virtual Joystick Logic
        window.addEventListener('pointerdown', e => {
            if(state.screen !== 'GAME') return;
            input.active = true;
            input.startX = e.clientX;
            input.startY = e.clientY;
            input.x = 0; input.y = 0;
        });
        
        window.addEventListener('pointermove', e => {
            if (!input.active) return;
            const dx = e.clientX - input.startX;
            const dy = e.clientY - input.startY;
            // Normalize
            const dist = Math.min(50, Math.sqrt(dx*dx + dy*dy)); // Max joystick radius
            const angle = Math.atan2(dy, dx);
            input.x = Math.cos(angle) * dist;
            input.y = Math.sin(angle) * dist;
        });
        
        window.addEventListener('pointerup', () => {
            input.active = false; input.x = 0; input.y = 0;
        });

        // --- Init ---
        window.onload = () => {
            resizeCanvas();
            loadMeta();
            
            document.getElementById('btnStart').onclick = startRun;
            document.getElementById('btnRetry').onclick = startRun;
            document.getElementById('btnHome').onclick = () => toggleUI('mainMenu');
            document.getElementById('btnShop').onclick = () => { toggleUI('shopScreen'); renderShop(); };
            document.getElementById('btnBack').onclick = () => toggleUI('mainMenu');
        };

    </script>
</body>
</html>