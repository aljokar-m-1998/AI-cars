<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Neon Survivor: Deep Space</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        let db, auth, userId;
        
        const initFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) return;
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        window.firebaseReady = true;
                        if(window.app && window.app.onAuth) window.app.onAuth(userId, db);
                    } else {
                        await signInAnonymously(auth);
                    }
                });
            } catch (e) { console.error("FB Error", e); }
        };

        initFirebase();
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;900&display=swap');
        
        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: #000;
            overflow: hidden;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            color: white;
        }

        /* Deep Space CSS Background */
        #gameCanvas {
            background: radial-gradient(circle at center, #0a0a12 0%, #000000 100%);
        }

        /* Enhanced Glassmorphism */
        .glass-panel {
            background: rgba(8, 8, 12, 0.65); /* More transparent */
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5), inset 0 0 20px rgba(255,255,255,0.02);
            border-radius: 16px;
        }

        .game-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; justify-content: center; align-items: center;
            z-index: 20;
        }
        
        .pointer-auto { pointer-events: auto; }

        .xp-rail {
            position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: rgba(255,255,255,0.1); z-index: 30;
        }
        .xp-fill {
            height: 100%; background: linear-gradient(90deg, #00f2ff, #0066ff);
            width: 0%; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 15px #00f2ff;
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(0.8); opacity: 0; }
            10% { transform: translateY(-20px) scale(1.5); opacity: 1; }
            100% { transform: translateY(-80px) scale(1); opacity: 0; }
        }
        .dmg-text {
            position: absolute; font-weight: 900; pointer-events: none;
            animation: floatUp 0.8s ease-out forwards;
            font-family: 'Rajdhani', sans-serif;
            text-shadow: 0 0 5px currentColor;
            z-index: 10;
        }

        .neon-text {
            text-shadow: 0 0 10px currentColor, 0 0 20px currentColor, 0 0 40px currentColor;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
    </style>
</head>
<body>

    <!-- HUD -->
    <div id="hud" class="hidden absolute inset-0 pointer-events-none z-10">
        <div class="xp-rail"><div id="xpBar" class="xp-fill"></div></div>
        
        <!-- Pause Button -->
        <button id="btnPauseGame" class="pointer-auto absolute top-4 left-1/2 -translate-x-1/2 bg-white/5 backdrop-blur border border-white/20 text-white rounded-full w-12 h-12 flex items-center justify-center hover:bg-white/20 transition-all z-50 text-xl shadow-[0_0_15px_rgba(255,255,255,0.2)]">
            ‚è∏
        </button>

        <!-- Stats Top Left -->
        <div class="absolute top-6 left-4 flex flex-col gap-3">
            <div class="glass-panel px-5 py-2 flex items-center gap-3 border-l-2 border-cyan-400">
                <span class="text-xs text-gray-400 font-bold uppercase tracking-widest">LVL</span>
                <span id="lvlDisplay" class="text-white font-black text-4xl neon-text text-cyan-400">1</span>
            </div>
            <div class="text-cyan-100 font-mono text-xl pl-2 opacity-80 tracking-widest drop-shadow-[0_0_5px_rgba(0,255,255,0.5)]" id="timeDisplay">00:00</div>
        </div>
        
        <!-- Stats Top Right -->
        <div class="absolute top-6 right-4 flex flex-col items-end gap-3">
            <div class="glass-panel px-4 py-2 text-yellow-400 font-bold border-r-2 border-yellow-500 flex items-center gap-2">
                <span id="goldRunDisplay">0</span> <span class="text-xl filter drop-shadow-[0_0_5px_yellow]">üíé</span>
            </div>
            <!-- HP Bar -->
            <div class="w-64 h-4 bg-gray-900/50 border border-white/10 relative overflow-hidden rounded-full">
                <div id="hpBar" class="h-full bg-gradient-to-r from-pink-600 to-rose-500 transition-all duration-200 box-shadow-[0_0_15px_#ec4899]" style="width: 100%"></div>
            </div>
            <div class="text-xs font-bold text-gray-400 tracking-widest" id="hpText">100 / 100</div>
        </div>

        <!-- Dash Button (Mobile) -->
        <div id="dashBtn" class="pointer-auto absolute bottom-12 right-8 w-24 h-24 rounded-full bg-cyan-500/10 border border-cyan-400/30 flex items-center justify-center backdrop-blur active:scale-95 transition-transform shadow-[0_0_30px_rgba(6,182,212,0.2)] group">
            <span class="text-3xl group-hover:scale-110 transition-transform filter drop-shadow-[0_0_10px_cyan]">‚ö°</span>
            <svg class="absolute w-full h-full -rotate-90 pointer-events-none">
                <circle cx="48" cy="48" r="46" fill="none" stroke="#22d3ee" stroke-width="2" 
                        stroke-dasharray="289" id="dashCircle" stroke-dashoffset="0" style="transition: stroke-dashoffset 0.1s linear"/>
            </svg>
        </div>
    </div>

    <!-- Pause Screen -->
    <div id="pauseScreen" class="game-ui hidden z-50 bg-black/60 backdrop-blur-md pointer-auto">
        <div class="glass-panel p-10 w-80 text-center flex flex-col gap-6 border border-white/10 shadow-[0_0_50px_rgba(0,0,0,0.8)]">
            <h2 class="text-5xl font-black text-white mb-2 tracking-[0.2em] neon-text text-white">PAUSED</h2>
            <button id="btnResume" class="bg-cyan-600/80 hover:bg-cyan-500 text-white font-bold py-4 tracking-widest transition-all rounded-lg border border-cyan-400/30 shadow-[0_0_20px_rgba(8,145,178,0.4)]">
                RESUME
            </button>
            <button id="btnExit" class="bg-transparent border border-red-500/30 text-red-400 hover:bg-red-500/10 font-bold py-4 tracking-widest transition-all rounded-lg">
                EXIT
            </button>
        </div>
    </div>

    <!-- Upgrade Screen -->
    <div id="upgradeScreen" class="game-ui hidden z-50 bg-black/80 backdrop-blur-xl pointer-auto">
        <div class="flex flex-col items-center w-full max-w-md p-6 gap-6 h-full justify-center">
            <div class="text-center">
                <h2 class="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-orange-500 mb-4 filter drop-shadow-[0_0_20px_orange]">LEVEL UP</h2>
            </div>
            <div id="upgradeCards" class="w-full flex flex-col gap-4"></div>
        </div>
    </div>

    <!-- Main Menu -->
    <div id="mainMenu" class="game-ui z-40 bg-black pointer-auto flex-col overflow-y-auto">
        <!-- Space Background Effect is in Canvas, this is UI layer -->
        <div class="absolute inset-0 z-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-indigo-900/20 via-black to-black"></div>

        <div class="w-full max-w-md p-6 flex flex-col items-center min-h-screen relative pt-20 z-10">
            <!-- Title -->
            <div class="relative mb-16 text-center group">
                <h1 class="text-8xl font-black text-white tracking-tighter relative z-10 neon-text text-cyan-500" style="font-size: 5rem; line-height: 0.9;">
                    NEON<br>SURVIVOR
                </h1>
                <div class="text-sm text-cyan-300/70 mt-4 tracking-[0.8em] font-light uppercase border-t border-cyan-500/30 pt-2">Deep Space</div>
            </div>
            
            <!-- Gold Display -->
            <div class="glass-panel w-full p-6 mb-8 flex justify-between items-center relative overflow-hidden group border border-yellow-500/30">
                <div class="absolute -right-10 -top-10 w-32 h-32 bg-yellow-500/10 rounded-full blur-3xl"></div>
                <div>
                    <div class="text-gray-400 text-[10px] uppercase font-bold tracking-wider mb-1">CREDITS</div>
                    <div class="text-yellow-400 font-black text-5xl global-gold-display drop-shadow-[0_0_10px_rgba(250,204,21,0.5)]">...</div>
                </div>
                <div class="text-5xl opacity-80 group-hover:scale-110 transition-transform filter drop-shadow-[0_0_15px_yellow]">üíé</div>
            </div>

            <!-- Buttons -->
            <div class="w-full grid gap-4">
                <button id="btnResumeRun" class="hidden bg-emerald-900/40 hover:bg-emerald-800/60 text-emerald-100 border border-emerald-500/50 font-bold py-5 text-lg tracking-widest uppercase flex items-center justify-center gap-3 shadow-[0_0_30px_rgba(16,185,129,0.1)] backdrop-blur-md rounded-xl">
                    <span class="animate-spin text-2xl">‚ü≥</span> Resume
                </button>

                <button id="btnStart" class="bg-blue-600/20 hover:bg-blue-600/40 text-blue-100 font-black py-6 text-2xl tracking-widest uppercase transition-all shadow-[0_0_40px_rgba(37,99,235,0.2)] border border-blue-400/40 backdrop-blur-md rounded-xl group relative overflow-hidden">
                    <span class="relative z-10 group-hover:text-white transition-colors">Launch</span>
                    <div class="absolute inset-0 bg-blue-500/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                </button>

                <div class="grid grid-cols-2 gap-4">
                    <button id="btnShop" class="glass-panel hover:bg-white/10 text-white font-bold py-6 transition-all flex flex-col items-center gap-2 border border-transparent hover:border-purple-500/50">
                        <span class="text-4xl mb-1 filter drop-shadow-[0_0_10px_purple]">üß¨</span>
                        <span class="text-[10px] tracking-widest uppercase text-gray-400 group-hover:text-white">Upgrades</span>
                    </button>
                    <button id="btnHeroes" class="glass-panel hover:bg-white/10 text-white font-bold py-6 transition-all flex flex-col items-center gap-2 border border-transparent hover:border-pink-500/50">
                        <span class="text-4xl mb-1 filter drop-shadow-[0_0_10px_pink]">üë∫</span>
                        <span class="text-[10px] tracking-widest uppercase text-gray-400 group-hover:text-white">Heroes</span>
                    </button>
                </div>
            </div>
            
            <div class="mt-auto pb-4 pt-12 opacity-30 hover:opacity-100 transition-opacity">
                <button onclick="app.resetSave()" class="text-[10px] text-red-500 uppercase tracking-widest border-b border-red-500/30 pb-1">Reset All Systems</button>
            </div>
        </div>
    </div>

    <!-- Shop Screen -->
    <div id="shopScreen" class="game-ui hidden z-50 bg-black/95 pointer-auto flex-col backdrop-blur-md">
        <div class="w-full max-w-md p-4 h-full flex flex-col">
            <div class="flex justify-between items-center mb-6 py-4 border-b border-white/10 sticky top-0 bg-black/50 backdrop-blur-xl z-20">
                <h2 class="text-3xl font-bold text-white uppercase tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">Research</h2>
                <div class="text-yellow-400 font-bold bg-white/5 px-4 py-2 border border-white/10 rounded-lg global-gold-display">0</div>
            </div>
            <div id="shopItems" class="space-y-4 overflow-y-auto flex-1 pb-32 pr-2 scrollbar-hide"></div>
            <div class="absolute bottom-6 left-1/2 -translate-x-1/2 w-[90%]">
                <button id="btnBackFromShop" class="w-full bg-white/10 text-white font-bold py-4 uppercase tracking-widest hover:bg-white/20 transition-all border border-white/10 rounded-xl backdrop-blur">Back</button>
            </div>
        </div>
    </div>

    <!-- Hero Screen -->
    <div id="heroScreen" class="game-ui hidden z-50 bg-black/95 pointer-auto flex-col backdrop-blur-md">
        <div class="w-full max-w-md p-6 h-full flex flex-col">
            <h2 class="text-3xl font-bold text-white mb-6 border-b border-white/10 pb-4 sticky top-0 bg-black/50 backdrop-blur-xl z-20 uppercase tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-red-500">Agents</h2>
            <div id="heroGrid" class="grid grid-cols-1 gap-4 overflow-y-auto flex-1 pb-32 pr-1"></div>
            <div class="absolute bottom-6 left-1/2 -translate-x-1/2 w-[90%]">
                <button id="btnBackFromHero" class="w-full bg-white/10 text-white font-bold py-4 uppercase tracking-widest hover:bg-white/20 transition-all border border-white/10 rounded-xl backdrop-blur">Back</button>
            </div>
        </div>
    </div>

    <!-- Game Over -->
    <div id="gameOverScreen" class="game-ui hidden z-50 bg-black/90 backdrop-blur-xl pointer-auto flex-col">
        <h2 class="text-8xl font-black text-white mb-2 tracking-tighter neon-text text-red-600 animate-pulse">KIA</h2>
        <p class="text-red-500 font-mono tracking-[0.5em] text-xs mb-12 uppercase">Signal Lost</p>
        
        <div class="glass-panel p-8 w-80 text-center mb-8 border border-red-500/30 shadow-[0_0_60px_rgba(220,38,38,0.15)]">
            <div class="grid grid-cols-2 gap-8 mb-6 border-b border-white/10 pb-6">
                <div>
                    <div class="text-[10px] text-gray-500 uppercase tracking-widest mb-1">Time</div>
                    <div class="text-white text-3xl font-mono font-bold drop-shadow-[0_0_5px_white]" id="endStatsTime">00:00</div>
                </div>
                <div>
                    <div class="text-[10px] text-gray-500 uppercase tracking-widest mb-1">Kills</div>
                    <div class="text-white text-3xl font-mono font-bold drop-shadow-[0_0_5px_white]" id="endStatsKills">0</div>
                </div>
            </div>
            <div>
                <div class="text-[10px] text-gray-500 uppercase mb-2">Loot Secured</div>
                <div class="text-yellow-400 text-6xl font-black flex justify-center items-center gap-3 filter drop-shadow-[0_0_15px_yellow]">
                    <span id="endStatsGold">0</span> <span class="text-3xl">üíé</span>
                </div>
            </div>
        </div>

        <button id="btnRetry" class="bg-white text-black font-black py-4 px-16 hover:scale-105 transition-transform shadow-[0_0_40px_rgba(255,255,255,0.4)] text-xl mb-4 uppercase tracking-widest rounded-full">
            Re-Deploy
        </button>
        <button id="btnHome" class="text-gray-500 hover:text-white transition-colors text-xs tracking-widest uppercase mt-4">Return to Base</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script type="module">
        import { doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Game Data (English) ---
        const HEROES = [
            { id: 'soldier', name: 'COMMANDER', desc: 'Balanced. Heavy Rifle.', cost: 0, hp: 150, speed: 3.5, img: 'üëÆ', color: '#00ccff', weapon: 'gun' },
            { id: 'tank', name: 'TITAN', desc: 'High HP. Area Damage.', cost: 2500, hp: 300, speed: 2.5, img: 'ü¶æ', color: '#00ff99', weapon: 'orbit' },
            { id: 'ninja', name: 'SPECTRE', desc: 'Fast. Critical Strikes.', cost: 5000, hp: 100, speed: 5.0, img: 'ü•∑', color: '#ff0055', weapon: 'shuriken' },
            { id: 'mage', name: 'VOLT', desc: 'Chain Lightning.', cost: 8000, hp: 120, speed: 3.2, img: '‚õàÔ∏è', color: '#cc00ff', weapon: 'lightning' }
        ];

        const PERM_UPGRADES = {
            damage: { name: 'Kinetic Boost', desc: 'Damage +10%', max: 50, cost: l => 100 + (l * 150), val: l => l * 0.1 }, 
            health: { name: 'Nano Armor', desc: 'Health +20', max: 50, cost: l => 100 + (l * 150), val: l => l * 20 }, 
            speed:  { name: 'Thrusters', desc: 'Speed +3% (Max 50%)', max: 15, cost: l => 200 + (l * 200), val: l => l * 0.03 },
            regen:  { name: 'Bio-Repair', desc: 'HP/Sec +0.5', max: 20, cost: l => 300 + (l * 250), val: l => l * 0.5 },
            magnet: { name: 'Loot Range', desc: 'Range +15%', max: 15, cost: l => 150 + (l * 150), val: l => l * 0.15 },
            greed:  { name: 'Crypto Miner', desc: 'Gold Gain +10%', max: 20, cost: l => 250 + (l * 250), val: l => l * 0.1 } 
        };

        const INGAME_UPGRADES = [
            { id: 'multishot', name: 'Split Barrel', desc: '+1 Projectile', rarity: 'rare', color: '#60a5fa' },
            { id: 'dmg', name: 'Hollow Point', desc: 'Damage +20%', rarity: 'common', color: '#f87171' },
            { id: 'haste', name: 'Rapid Fire', desc: 'Fire Rate +15%', rarity: 'common', color: '#fbbf24' },
            { id: 'speed', name: 'Adrenaline', desc: 'Move Speed +10%', rarity: 'common', color: '#34d399' },
            { id: 'orbit', name: 'Plasma Orb', desc: '+1 Protective Orb', rarity: 'epic', color: '#c084fc' },
            { id: 'lightning', name: 'Tesla Coil', desc: 'Zaps nearby enemies', rarity: 'epic', color: '#facc15' },
            { id: 'heal', name: 'Stimpack', desc: 'Heal 50% HP', rarity: 'rare', color: '#f472b6' },
            { id: 'crit', name: 'Targeting Sys', desc: 'Crit Chance +10%', rarity: 'rare', color: '#e879f9' }
        ];

        // --- Engine & State ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let W, H;

        let Game = {
            state: 'MENU', 
            data: {
                gold: 0,
                unlockedHeroes: ['soldier'],
                upgrades: { damage: 0, health: 0, speed: 0, regen: 0, magnet: 0, greed: 0 },
                selectedHero: 'soldier'
            },
            player: null,
            enemies: [],
            bullets: [],
            gems: [],
            particles: [],
            texts: [],
            stars: [], // New Starfield
            time: 0, level: 1, xp: 0, xpNext: 100, kills: 0, runGold: 0,
            spawner: { next: 0 },
            camera: { x: 0, y: 0, shake: 0 },
            input: { active: false, x: 0, y: 0, px: 0, py: 0 }
        };

        // --- Sound ---
        let AudioSys = {
            synth: null,
            init: async () => {
                if(AudioSys.synth) return;
                await Tone.start();
                AudioSys.synth = new Tone.PolySynth(Tone.Synth).toDestination();
                AudioSys.synth.volume.value = -12;
                AudioSys.bass = new Tone.MembraneSynth().toDestination();
                AudioSys.bass.volume.value = -8;
            },
            play: (type) => {
                if(!AudioSys.synth) return;
                try {
                    if(type === 'shoot') AudioSys.synth.triggerAttackRelease("C5", "64n", undefined, 0.05);
                    if(type === 'hit') AudioSys.synth.triggerAttackRelease("F2", "32n", undefined, 0.1);
                    if(type === 'coin') AudioSys.synth.triggerAttackRelease("B5", "32n", undefined, 0.05);
                    if(type === 'levelup') AudioSys.synth.triggerAttackRelease(["C4","E4","G4","C5"], "8n");
                    if(type === 'explode') AudioSys.bass.triggerAttackRelease("C1", "16n");
                    if(type === 'dash') AudioSys.bass.triggerAttackRelease("G2", "16n");
                } catch(e) {}
            }
        };

        // --- Sync & Persistence ---
        function updateGlobalUI() {
            document.querySelectorAll('.global-gold-display').forEach(el => {
                el.innerText = Game.data.gold.toLocaleString();
            });
        }

        function saveProfile() {
            const dataToSave = { 
                gold: Game.data.gold, 
                unlockedHeroes: Game.data.unlockedHeroes, 
                upgrades: Game.data.upgrades, 
                selectedHero: Game.data.selectedHero 
            };
            updateGlobalUI();
            if (window.firebaseObj && window.firebaseObj.getUserId()) {
                const ref = doc(window.firebaseObj.db(), `artifacts/${appId}/users/${window.firebaseObj.getUserId()}/data/neon_profile`);
                setDoc(ref, dataToSave, { merge: true });
            } else {
                localStorage.setItem('neon_deep_profile', JSON.stringify(dataToSave));
            }
        }

        function saveCurrentRun() {
            if(Game.state !== 'GAME' && Game.state !== 'PAUSED') return;
            if(Game.player.hp <= 0) return;

            const runData = {
                player: {
                    x: Game.player.x, y: Game.player.y, hp: Game.player.hp, maxHp: Game.player.maxHp,
                    speed: Game.player.speed, weapon: Game.player.weapon, passives: Game.player.passives,
                    magnet: Game.player.magnet, color: Game.player.color, dashCd: Game.player.dashCd,
                    invincible: Game.player.invincible || 0 
                },
                time: Game.time, level: Game.level, xp: Game.xp, xpNext: Game.xpNext,
                kills: Game.kills, runGold: Game.runGold, heroId: Game.data.selectedHero
            };
            localStorage.setItem('neon_deep_run', JSON.stringify(runData));
        }

        function clearSavedRun() {
            localStorage.removeItem('neon_deep_run');
            updateResumeButton();
        }

        window.app = {
            onAuth: (uid, db) => {
                const ref = doc(db, `artifacts/${appId}/users/${uid}/data/neon_profile`);
                onSnapshot(ref, (snap) => {
                    if (snap.exists()) {
                        Game.data = { ...Game.data, ...snap.data() };
                        if(!Game.data.upgrades) Game.data.upgrades = {};
                        updateGlobalUI();
                    }
                });
            },
            resetSave: () => {
                if(confirm('Warning: Factory Reset? All data will be wiped.')) {
                    localStorage.clear();
                    location.reload();
                }
            }
        };

        const local = JSON.parse(localStorage.getItem('neon_deep_profile') || 'null');
        if(local) {
            Game.data = { ...Game.data, ...local };
            if(!Game.data.upgrades) Game.data.upgrades = {};
            updateGlobalUI();
        }

        function updateResumeButton() {
            const hasRun = localStorage.getItem('neon_deep_run');
            const btn = document.getElementById('btnResumeRun');
            if(hasRun) btn.classList.remove('hidden');
            else btn.classList.add('hidden');
        }

        // --- Starfield System (Visuals) ---
        function initStars() {
            Game.stars = [];
            for(let i=0; i<150; i++) {
                Game.stars.push({
                    x: Math.random() * W,
                    y: Math.random() * H,
                    size: Math.random() * 2 + 0.5,
                    alpha: Math.random() * 0.5 + 0.1,
                    speed: Math.random() * 0.5 + 0.1 // Parallax factor
                });
            }
        }

        // --- Core Loop ---
        function init() {
            resize();
            initStars();
            window.addEventListener('resize', () => { resize(); initStars(); });
            updateResumeButton();
            updateGlobalUI();

            document.addEventListener('visibilitychange', () => {
                if (document.hidden && Game.state === 'GAME') togglePause();
            });

            // Input
            const handleStart = (e) => {
                if(Game.state !== 'GAME') return;
                Game.input.active = true;
                const p = e.touches ? e.touches[0] : e;
                Game.input.px = p.clientX; Game.input.py = p.clientY;
                AudioSys.init();
            };
            const handleMove = (e) => {
                if(!Game.input.active) return;
                const p = e.touches ? e.touches[0] : e;
                const dx = p.clientX - Game.input.px;
                const dy = p.clientY - Game.input.py;
                const dist = Math.min(80, Math.sqrt(dx*dx + dy*dy));
                const angle = Math.atan2(dy, dx);
                Game.input.x = Math.cos(angle) * dist;
                Game.input.y = Math.sin(angle) * dist;
            };
            const handleEnd = () => { Game.input.active = false; Game.input.x=0; Game.input.y=0; };

            canvas.addEventListener('mousedown', handleStart);
            canvas.addEventListener('mousemove', handleMove);
            window.addEventListener('mouseup', handleEnd);
            canvas.addEventListener('touchstart', handleStart);
            canvas.addEventListener('touchmove', handleMove);
            window.addEventListener('touchend', handleEnd);

            document.getElementById('btnStart').onclick = () => startGame(false);
            document.getElementById('btnResumeRun').onclick = () => startGame(true);
            document.getElementById('dashBtn').onclick = playerDash;
            document.getElementById('btnShop').onclick = () => { setScreen('SHOP'); renderShop(); };
            document.getElementById('btnHeroes').onclick = () => { setScreen('HEROES'); renderHeroes(); };
            document.getElementById('btnPauseGame').onclick = togglePause;
            document.getElementById('btnResume').onclick = togglePause;
            document.getElementById('btnExit').onclick = () => { saveCurrentRun(); setScreen('MENU'); updateResumeButton(); };
            document.getElementById('btnBackFromShop').onclick = () => setScreen('MENU');
            document.getElementById('btnBackFromHero').onclick = () => setScreen('MENU');
            document.getElementById('btnRetry').onclick = () => startGame(false);
            document.getElementById('btnHome').onclick = () => setScreen('MENU');

            requestAnimationFrame(loop);
        }

        function setScreen(screen) {
            Game.state = screen;
            document.querySelectorAll('.game-ui').forEach(el => el.classList.add('hidden'));
            document.getElementById('hud').classList.add('hidden');

            if(screen === 'MENU') document.getElementById('mainMenu').classList.remove('hidden');
            if(screen === 'GAME') document.getElementById('hud').classList.remove('hidden');
            if(screen === 'PAUSED') {
                document.getElementById('hud').classList.remove('hidden');
                document.getElementById('pauseScreen').classList.remove('hidden');
            }
            if(screen === 'SHOP') document.getElementById('shopScreen').classList.remove('hidden');
            if(screen === 'HEROES') document.getElementById('heroScreen').classList.remove('hidden');
            if(screen === 'GAMEOVER') document.getElementById('gameOverScreen').classList.remove('hidden');
            if(screen === 'LEVELUP') document.getElementById('upgradeScreen').classList.remove('hidden');
        }

        function togglePause() {
            if(Game.state === 'GAME') {
                setScreen('PAUSED');
                saveCurrentRun();
            } else if(Game.state === 'PAUSED') {
                setScreen('GAME');
            }
        }

        function startGame(isResume) {
            let savedRun = null;
            if(isResume) {
                try { savedRun = JSON.parse(localStorage.getItem('neon_deep_run')); } catch(e){}
            }

            if(isResume && savedRun) {
                Game.player = { ...savedRun.player, trail: [] };
                if (typeof Game.player.invincible !== 'number') Game.player.invincible = 0;
                Game.time = savedRun.time; Game.level = savedRun.level; Game.xp = savedRun.xp;
                Game.xpNext = savedRun.xpNext; Game.kills = savedRun.kills; Game.runGold = savedRun.runGold;
                Game.data.selectedHero = savedRun.heroId;
            } else {
                const hero = HEROES.find(h => h.id === Game.data.selectedHero);
                const ups = Game.data.upgrades;

                const maxHp = hero.hp + PERM_UPGRADES.health.val(ups.health || 0);
                const speed = hero.speed * (1 + PERM_UPGRADES.speed.val(ups.speed || 0));
                const dmgMult = 1 + PERM_UPGRADES.damage.val(ups.damage || 0);
                const regen = PERM_UPGRADES.regen.val(ups.regen || 0);
                const magnetBonus = PERM_UPGRADES.magnet.val(ups.magnet || 0);

                Game.player = {
                    x: 0, y: 0,
                    hp: maxHp, maxHp: maxHp,
                    speed: speed,
                    invincible: 60,
                    dashCd: 0,
                    weapon: { 
                        type: hero.weapon, 
                        dmg: 12 * dmgMult, rate: 30, count: 1, lastShot: 0, critChance: 0.05
                    },
                    magnet: 100 * (1 + magnetBonus),
                    passives: { orbit: 0, lightning: 0, regen: regen },
                    color: hero.color,
                    trail: []
                };
                Game.time = 0; Game.level = 1; Game.xp = 0; Game.xpNext = 100;
                Game.runGold = 0; Game.kills = 0;
            }

            Game.enemies = []; Game.bullets = []; Game.gems = []; Game.particles = []; Game.texts = [];
            Game.spawner = { next: Game.time };
            
            setScreen('GAME');
            AudioSys.init();
            clearSavedRun(); 
        }

        function loop() {
            requestAnimationFrame(loop);
            if(Game.state !== 'GAME') return;
            const dt = 1/60; Game.time += dt;

            updatePlayer();
            updateWeapons();
            updateEnemies(); 
            updatePhysics();
            render();
            
            if(Math.floor(Game.time * 60) % 10 === 0) updateHUD();
        }

        function updatePlayer() {
            const p = Game.player;
            if(Game.input.active || Game.input.x !== 0) {
                const len = Math.sqrt(Game.input.x**2 + Game.input.y**2);
                if(len > 0) {
                    const factor = len / 80;
                    p.x += (Game.input.x / len) * p.speed * factor;
                    p.y += (Game.input.y / len) * p.speed * factor;
                }
            }
            if(p.dashCd > 0) p.dashCd--;
            if(p.invincible > 0) p.invincible--;
            
            if(p.passives.regen > 0 && Game.time % 1 < 0.02) p.hp = Math.min(p.maxHp, p.hp + p.passives.regen);

            if(Game.time % 0.1 < 0.02) p.trail.push({x: p.x, y: p.y, life: 1});
            for(let i=p.trail.length-1; i>=0; i--) {
                p.trail[i].life -= 0.05;
                if(p.trail[i].life <= 0) p.trail.splice(i,1);
            }

            const dashPct = Math.max(0, p.dashCd / 90) * 100;
            const dashC = document.getElementById('dashCircle');
            if(dashC) dashC.style.strokeDashoffset = (289 * dashPct) / 100;
        }

        function playerDash() {
            const p = Game.player;
            if(p.dashCd > 0) return;
            p.dashCd = 90; p.invincible = 45; 
            const angle = Math.atan2(Game.input.y, Game.input.x) || 0;
            p.x += Math.cos(angle) * 180;
            p.y += Math.sin(angle) * 180;
            spawnExplosion(p.x, p.y, '#fff', 15, false); 
            AudioSys.play('dash');
            Game.camera.shake = 8;
        }

        function updateWeapons() {
            const p = Game.player;
            p.weapon.lastShot--;
            
            if(p.weapon.lastShot <= 0) {
                let target = null, minDist = 600; 
                for(let e of Game.enemies) {
                    const d = Math.hypot(e.x - p.x, e.y - p.y);
                    if(d < minDist) { minDist = d; target = e; }
                }

                if(target || p.weapon.type === 'shuriken') {
                    const angle = target ? Math.atan2(target.y - p.y, target.x - p.x) : Math.random()*Math.PI*2;
                    for(let i=0; i<p.weapon.count; i++) {
                        const spread = (i - (p.weapon.count-1)/2) * 0.15;
                        Game.bullets.push({ 
                            x: p.x, y: p.y, 
                            vx: Math.cos(angle+spread)*12, vy: Math.sin(angle+spread)*12, 
                            life: 60, 
                            color: p.weapon.type === 'lightning' ? '#facc15' : '#00f3ff'
                        });
                    }
                    AudioSys.play('shoot');
                    p.weapon.lastShot = p.weapon.rate;
                }
            }

            if(p.passives.orbit > 0) {
                const spd = Game.time * 3;
                const count = p.passives.orbit * 2; 
                for(let i=0; i<count; i++) {
                    const a = spd + (i * (Math.PI*2/count));
                    const ox = p.x + Math.cos(a)*120, oy = p.y + Math.sin(a)*120; 
                    for(let e of Game.enemies) {
                        if(Math.hypot(e.x-ox, e.y-oy) < e.size + 25) damageEnemy(e, p.weapon.dmg * 0.4, false);
                    }
                }
            }

            if(p.passives.lightning > 0 && Math.random() < 0.05) { 
                const e = Game.enemies[Math.floor(Math.random()*Game.enemies.length)];
                if(e) {
                    Game.particles.push({type:'lightning', x1:p.x, y1:p.y, x2:e.x, y2:e.y, life:10, color:'#facc15'});
                    damageEnemy(e, p.weapon.dmg * (1 + p.passives.lightning * 0.5), true);
                }
            }
        }

        function updateEnemies() {
            if(Game.enemies.length > 250) return;

            if(Game.time > Game.spawner.next) {
                const factor = 1 + (Game.time/60) * 0.5 + (Game.level * 0.1);
                const angle = Math.random() * Math.PI * 2;
                const r = Math.max(W, H) / 1.5 + 50;
                const ex = Game.player.x + Math.cos(angle) * r;
                const ey = Game.player.y + Math.sin(angle) * r;
                
                let type = 'drone', hp = 15 * factor, speed = 1.5 + Math.min(3, factor * 0.1);
                let size = 15, color = '#ef4444', xp = 1;

                const roll = Math.random();
                if(roll < 0.2) { type = 'rusher'; speed *= 1.6; hp *= 0.6; color = '#fbbf24'; } 
                if(roll > 0.9) { type = 'tank'; speed *= 0.7; hp *= 4; size=28; color = '#818cf8'; xp=5; } 

                const isElite = Math.floor(Game.time) % 60 > 55 && Math.random() < 0.05;
                if(isElite) {
                    type = 'elite'; hp *= 20; size = 60; speed = 1.8; color = '#9333ea'; xp = 50;
                    Game.texts.push({x:Game.player.x, y:Game.player.y-100, text:"‚ö†Ô∏è ELITE ‚ö†Ô∏è", color:"#9333ea", life:3, vy:0});
                }

                Game.enemies.push({ x: ex, y: ey, hp, maxHp: hp, speed, size, color, xp, isElite });
                Game.spawner.next = Game.time + Math.max(0.05, 0.8 - (factor * 0.05));
            }

            for(let e of Game.enemies) {
                const angle = Math.atan2(Game.player.y - e.y, Game.player.x - e.x);
                e.x += Math.cos(angle) * e.speed;
                e.y += Math.sin(angle) * e.speed;

                if(Math.random() < 0.2) { 
                   for(let other of Game.enemies) {
                       if(e === other) continue;
                       const dx = e.x - other.x;
                       const dy = e.y - other.y;
                       if(Math.abs(dx) < 30 && Math.abs(dy) < 30) { 
                           e.x += dx * 0.1; e.y += dy * 0.1;
                       }
                   }
                }

                if((Game.player.invincible||0) <= 0) {
                    if(Math.hypot(e.x - Game.player.x, e.y - Game.player.y) < e.size + 15) {
                        Game.player.hp -= 20;
                        Game.player.invincible = 30;
                        Game.camera.shake = 10;
                        AudioSys.play('hit');
                        if(Game.player.hp <= 0) gameOver();
                    }
                }
            }
        }

        function updatePhysics() {
            for(let i=Game.bullets.length-1; i>=0; i--) {
                const b = Game.bullets[i];
                b.x += b.vx; b.y += b.vy; b.life--;
                if(Math.abs(b.x - Game.player.x) > W || Math.abs(b.y - Game.player.y) > H) b.life = 0;

                if(b.life <= 0) { Game.bullets.splice(i, 1); continue; }
                
                for(let e of Game.enemies) {
                    if(Math.hypot(b.x - e.x, b.y - e.y) < e.size + 10) {
                        damageEnemy(e, Game.player.weapon.dmg, true);
                        spawnExplosion(b.x, b.y, b.color, 3, false); 
                        Game.bullets.splice(i, 1);
                        break;
                    }
                }
            }

            for(let i=Game.gems.length-1; i>=0; i--) {
                const g = Game.gems[i];
                const dist = Math.hypot(g.x - Game.player.x, g.y - Game.player.y);
                
                if(dist < Game.player.magnet) {
                    const pull = 150 / (dist + 10);
                    g.x += (Game.player.x - g.x) * 0.1 * pull;
                    g.y += (Game.player.y - g.y) * 0.1 * pull;
                }
                
                if(dist < 30) {
                    if(g.type === 'gold') {
                        const mult = 1 + PERM_UPGRADES.greed.val(Game.data.upgrades.greed || 0);
                        Game.runGold += Math.max(1, Math.floor(g.val * mult));
                        AudioSys.play('coin');
                        spawnText(g.x, g.y, `+${Math.floor(g.val)}`, '#fbbf24');
                    } else {
                        Game.xp += g.val;
                        if(Game.xp >= Game.xpNext) levelUp();
                    }
                    Game.gems.splice(i, 1);
                }
            }
        }

        function spawnText(x, y, txt, color, isCrit) {
            if(Game.texts.length > 50) Game.texts.shift();
            Game.texts.push({ x, y, text: txt, color, life: 1, vy: -1, isCrit });
        }

        function damageEnemy(e, amt, canCrit) {
            let isCrit = false;
            if(canCrit && Math.random() < (Game.player.weapon.critChance || 0.05)) {
                amt *= 2.0; isCrit = true;
            }

            e.hp -= amt;
            
            if(isCrit || Math.random() > 0.7) {
                spawnText(e.x + (Math.random()*20-10), e.y - 20, Math.floor(amt), isCrit ? '#fbbf24' : '#fff', isCrit);
            }

            if(e.hp <= 0) {
                Game.kills++;
                AudioSys.play('explode');
                spawnExplosion(e.x, e.y, e.color, 12, true); 
                
                const roll = Math.random();
                const isGold = roll > 0.92 || e.isElite; 
                
                Game.gems.push({ x: e.x, y: e.y, val: isGold ? (e.isElite ? 500 : 10) : e.xp, type: isGold ? 'gold' : 'xp' });

                const idx = Game.enemies.indexOf(e);
                if(idx > -1) Game.enemies.splice(idx, 1);
            }
        }

        function spawnExplosion(x, y, color, count, shockwave) {
            for(let i=0; i<count; i++) {
                const angle = Math.random() * Math.PI * 2;
                const spd = Math.random() * 4 + 2;
                Game.particles.push({
                    x, y, 
                    vx: Math.cos(angle) * spd, 
                    vy: Math.sin(angle) * spd,
                    life: 1.0, 
                    color: color,
                    type: 'spark'
                });
            }
            if(shockwave) {
                Game.particles.push({
                    x, y, radius: 1, maxRadius: 50, life: 1.0, color: color, type: 'shockwave'
                });
            }
        }

        function levelUp() {
            Game.xp -= Game.xpNext;
            Game.xpNext = Math.floor(Game.xpNext * 1.2);
            Game.level++;
            setScreen('LEVELUP');
            AudioSys.play('levelup');
            
            const div = document.getElementById('upgradeCards');
            div.innerHTML = '';
            
            const options = [];
            for(let i=0; i<3; i++) options.push(INGAME_UPGRADES[Math.floor(Math.random()*INGAME_UPGRADES.length)]);
            
            options.forEach(u => {
                const card = document.createElement('div');
                card.className = `glass-panel p-4 rounded-xl flex justify-between items-center cursor-pointer card-anim border-l-4 hover:bg-white/10 transition-colors`;
                card.style.borderLeftColor = u.color;
                card.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-bold text-lg text-white">${u.name}</span>
                        <span class="text-xs text-gray-400">${u.desc}</span>
                    </div>
                    <div class="text-xs font-bold px-2 py-1 rounded bg-gray-800" style="color:${u.color}">${u.rarity.toUpperCase()}</div>
                `;
                card.onclick = () => {
                    applyInGameUpgrade(u);
                    setScreen('GAME');
                    saveCurrentRun();
                };
                div.appendChild(card);
            });
        }

        function applyInGameUpgrade(u) {
            const p = Game.player;
            if(u.id === 'multishot') p.weapon.count++;
            if(u.id === 'dmg') p.weapon.dmg *= 1.20;
            if(u.id === 'haste') p.weapon.rate = Math.max(5, p.weapon.rate * 0.85);
            if(u.id === 'speed') p.speed = Math.min(12, p.speed * 1.1);
            if(u.id === 'orbit') p.passives.orbit++;
            if(u.id === 'lightning') p.passives.lightning++;
            if(u.id === 'heal') p.hp = Math.min(p.maxHp, p.hp + p.maxHp * 0.5);
            if(u.id === 'crit') p.weapon.critChance = (p.weapon.critChance || 0.05) + 0.1;
        }

        function render() {
            if(Game.camera.shake > 0) {
                const s = Game.camera.shake;
                ctx.setTransform(1,0,0,1, (Math.random()-0.5)*s, (Math.random()-0.5)*s);
                Game.camera.shake *= 0.9;
                if(Game.camera.shake < 0.5) Game.camera.shake = 0;
            } else {
                ctx.setTransform(1,0,0,1,0,0);
            }

            // Clear with deep space black
            ctx.fillStyle = '#020205';
            ctx.fillRect(0,0,W,H);

            const p = Game.player;
            const camX = W/2 - p.x;
            const camY = H/2 - p.y;

            // --- Draw Stars (Parallax) ---
            // We draw stars BEFORE translating the context for the game world, 
            // but we calculate their position based on player movement
            Game.stars.forEach(star => {
                let x = (star.x - p.x * star.speed) % W;
                let y = (star.y - p.y * star.speed) % H;
                if(x < 0) x += W;
                if(y < 0) y += H;

                ctx.globalAlpha = star.alpha;
                ctx.fillStyle = '#ffffff';
                ctx.beginPath();
                ctx.arc(x, y, star.size, 0, Math.PI*2);
                ctx.fill();
            });
            ctx.globalAlpha = 1;

            ctx.translate(camX, camY);

            // --- Game World ---
            
            // Faint Grid (Holo effect)
            ctx.strokeStyle = '#111827'; ctx.lineWidth = 1;
            const gs = 200;
            const sx = Math.floor((p.x - W/2)/gs)*gs, sy = Math.floor((p.y - H/2)/gs)*gs;
            ctx.beginPath();
            for(let x=sx; x<sx+W+gs; x+=gs) { ctx.moveTo(x, p.y-H); ctx.lineTo(x, p.y+H); }
            for(let y=sy; y<sy+H+gs; y+=gs) { ctx.moveTo(p.x-W, y); ctx.lineTo(p.x+W, y); }
            ctx.stroke();

            // Set Glow Mode
            ctx.globalCompositeOperation = 'lighter';

            // Gems (Neon)
            Game.gems.forEach(g => {
                const color = g.type === 'gold' ? '#fbbf24' : '#06b6d4';
                ctx.shadowBlur = 10; ctx.shadowColor = color; ctx.fillStyle = color;
                ctx.beginPath(); ctx.arc(g.x, g.y, 4, 0, Math.PI*2); ctx.fill();
                ctx.shadowBlur = 0;
            });

            // Trail
            p.trail.forEach(t => {
                ctx.globalAlpha = t.life * 0.2; ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(t.x, t.y, 10, 0, Math.PI*2); ctx.fill();
            });
            ctx.globalAlpha = 1;

            // Player (Glowing Core)
            ctx.shadowBlur = 25; ctx.shadowColor = p.color; ctx.fillStyle = p.invincible > 0 ? '#fff' : p.color;
            ctx.beginPath(); ctx.arc(p.x, p.y, 16, 0, Math.PI*2); ctx.fill();
            
            // Player Pulse Ring
            ctx.strokeStyle = p.color; ctx.lineWidth = 2; ctx.globalAlpha = 0.5 + Math.sin(Game.time * 5) * 0.3;
            ctx.beginPath(); ctx.arc(p.x, p.y, 22, 0, Math.PI*2); ctx.stroke();
            ctx.globalAlpha = 1; ctx.shadowBlur = 0;

            // Orbits
            if(p.passives.orbit > 0) {
                const spd = Game.time * 3;
                const count = p.passives.orbit * 2;
                for(let i=0; i<count; i++) {
                    const a = spd + (i * (Math.PI*2/count));
                    ctx.shadowBlur=15; ctx.shadowColor='#a855f7'; ctx.fillStyle = '#a855f7'; 
                    ctx.beginPath(); ctx.arc(p.x + Math.cos(a)*120, p.y + Math.sin(a)*120, 6, 0, Math.PI*2); ctx.fill();
                    ctx.shadowBlur=0;
                }
            }

            // Enemies (Neon Outlines)
            Game.enemies.forEach(e => {
                ctx.save();
                ctx.translate(e.x, e.y);
                const angle = Math.atan2(p.y - e.y, p.x - e.x);
                ctx.rotate(angle);
                
                // Color Intensity
                ctx.fillStyle = e.color;
                if(e.isElite) { ctx.shadowBlur = 30; ctx.shadowColor = e.color; }
                else { ctx.shadowBlur = 5; ctx.shadowColor = e.color; }

                ctx.beginPath();
                ctx.moveTo(e.size/2, 0);
                ctx.lineTo(-e.size/2, -e.size/2);
                ctx.lineTo(-e.size/4, 0);
                ctx.lineTo(-e.size/2, e.size/2);
                ctx.closePath();
                ctx.fill();

                ctx.restore();
            });

            // Bullets (Lasers)
            Game.bullets.forEach(b => {
                ctx.shadowBlur = 10; ctx.shadowColor = b.color; ctx.fillStyle = b.color;
                ctx.beginPath(); ctx.arc(b.x, b.y, 3, 0, Math.PI*2); ctx.fill();
            });
            ctx.shadowBlur = 0;

            // Particles (Glow Sparks)
            Game.particles.forEach((pt, i) => {
                if(pt.type === 'shockwave') {
                    ctx.strokeStyle = pt.color; ctx.lineWidth = 2 * pt.life; ctx.globalAlpha = pt.life;
                    ctx.beginPath(); ctx.arc(pt.x, pt.y, pt.radius, 0, Math.PI*2); ctx.stroke();
                    pt.radius += (pt.maxRadius - pt.radius) * 0.1; pt.life -= 0.05;
                } else if (pt.type === 'lightning') {
                    ctx.strokeStyle = pt.color; ctx.lineWidth = 2; ctx.globalAlpha = pt.life/10;
                    ctx.shadowBlur = 15; ctx.shadowColor = pt.color;
                    ctx.beginPath(); ctx.moveTo(pt.x1, pt.y1); 
                    const midX = (pt.x1+pt.x2)/2 + (Math.random()-0.5)*30;
                    const midY = (pt.y1+pt.y2)/2 + (Math.random()-0.5)*30;
                    ctx.lineTo(midX, midY); ctx.lineTo(pt.x2, pt.y2); ctx.stroke();
                    pt.life--;
                } else {
                    pt.x += pt.vx; pt.y += pt.vy; pt.life -= 0.04;
                    ctx.globalAlpha = pt.life; ctx.fillStyle = pt.color;
                    ctx.fillRect(pt.x, pt.y, 4, 4);
                }
                if(pt.life <= 0) Game.particles.splice(i, 1);
            });

            // Reset Blend Mode for Text
            ctx.globalCompositeOperation = 'source-over';
            ctx.globalAlpha = 1;

            // Damage Numbers
            Game.texts.forEach((t, i) => {
                ctx.fillStyle = t.color;
                ctx.font = t.isCrit ? "900 24px 'Rajdhani'" : "700 16px 'Rajdhani'";
                ctx.shadowColor = '#000'; ctx.shadowBlur = 4;
                ctx.fillText(t.text, t.x, t.y);
                t.y += t.vy; t.life -= 0.02;
                if(t.life <= 0) Game.texts.splice(i, 1);
            });

            ctx.setTransform(1,0,0,1,0,0);
        }

        function updateHUD() {
            const hpPct = Math.max(0, (Game.player.hp / Game.player.maxHp) * 100);
            document.getElementById('hpBar').style.width = `${hpPct}%`;
            document.getElementById('hpText').innerText = `${Math.ceil(Game.player.hp)} / ${Math.ceil(Game.player.maxHp)}`;
            const xpPct = (Game.xp / Game.xpNext) * 100;
            document.getElementById('xpBar').style.width = `${xpPct}%`;
            document.getElementById('lvlDisplay').innerText = Game.level;
            document.getElementById('goldRunDisplay').innerText = Game.runGold.toLocaleString();
            const m = Math.floor(Game.time / 60);
            const s = Math.floor(Game.time % 60);
            document.getElementById('timeDisplay').innerText = `${m}:${s<10?'0'+s:s}`;
        }

        function renderShop() {
            const list = document.getElementById('shopItems');
            list.innerHTML = '';
            updateGlobalUI();
            Object.keys(PERM_UPGRADES).forEach(key => {
                const u = PERM_UPGRADES[key];
                const lvl = Game.data.upgrades[key] || 0;
                const cost = u.cost(lvl);
                const isMax = lvl >= u.max;
                const div = document.createElement('div');
                div.className = "glass-panel p-4 rounded-xl flex justify-between items-center border-l-2 border-blue-500 mb-2";
                div.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-white text-lg font-rajdhani">${u.name}</span>
                            <span class="text-[10px] bg-blue-900 px-2 py-0.5 rounded text-blue-200">LVL ${lvl}</span>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">${u.desc}</div>
                    </div>
                    <button class="ml-4 px-5 py-3 rounded-lg font-bold text-sm transition-all active:scale-95 border border-white/10 ${Game.data.gold >= cost && !isMax ? 'bg-yellow-600 hover:bg-yellow-500 text-white shadow-lg' : 'bg-gray-800 text-gray-500 cursor-not-allowed'}">
                        ${isMax ? 'MAX' : cost + ' üíé'}
                    </button>
                `;
                if(Game.data.gold >= cost && !isMax) {
                    div.querySelector('button').onclick = () => {
                        Game.data.gold -= cost;
                        Game.data.upgrades[key] = (Game.data.upgrades[key] || 0) + 1;
                        saveProfile();
                        AudioSys.play('coin');
                        renderShop();
                    };
                }
                list.appendChild(div);
            });
        }

        function renderHeroes() {
            const grid = document.getElementById('heroGrid');
            grid.innerHTML = '';
            HEROES.forEach(h => {
                const unlocked = Game.data.unlockedHeroes.includes(h.id);
                const selected = Game.data.selectedHero === h.id;
                const div = document.createElement('div');
                div.className = `glass-panel p-4 rounded-xl flex items-center gap-4 relative cursor-pointer active:scale-95 transition-transform ${selected ? 'border-green-500 bg-green-900/20' : (unlocked ? 'border-gray-700' : 'opacity-60 grayscale')}`;
                div.innerHTML = `
                    <div class="text-4xl bg-black/50 p-3 rounded-full border border-white/10">${h.img}</div>
                    <div class="flex-1">
                        <div class="font-black text-white text-lg tracking-wide">${h.name}</div>
                        <div class="text-xs text-gray-400">${h.desc}</div>
                    </div>
                    <div>
                         ${!unlocked 
                            ? `<button class="bg-yellow-600 text-white font-bold px-4 py-2 rounded-lg text-sm shadow-lg">${h.cost} üíé</button>` 
                            : (selected 
                                ? '<div class="text-green-400 font-bold text-xs border border-green-500 px-2 py-1 rounded tracking-widest">ACTIVE</div>' 
                                : '<div class="text-gray-500 text-xs border border-gray-600 px-2 py-1 rounded tracking-widest">SELECT</div>')}
                    </div>
                `;
                div.onclick = () => {
                    if(unlocked) {
                        Game.data.selectedHero = h.id;
                        saveProfile();
                        renderHeroes();
                    } else if(Game.data.gold >= h.cost) {
                        Game.data.gold -= h.cost;
                        Game.data.unlockedHeroes.push(h.id);
                        Game.data.selectedHero = h.id;
                        saveProfile();
                        AudioSys.play('coin');
                        renderHeroes();
                    }
                };
                grid.appendChild(div);
            });
        }

        function gameOver() {
            setScreen('GAMEOVER');
            clearSavedRun();
            Game.data.gold += Game.runGold;
            saveProfile();
            document.getElementById('endStatsTime').innerText = document.getElementById('timeDisplay').innerText;
            document.getElementById('endStatsKills').innerText = Game.kills;
            document.getElementById('endStatsGold').innerText = Game.runGold.toLocaleString();
        }

        function resize() { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; }
        
        window.onload = init;
    </script>
</body>
</html>