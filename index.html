<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Neon Survivor: Extraction</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        let db, auth, userId;

        const initFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) return;
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        window.firebaseReady = true;
                        if(window.app && window.app.onAuth) window.app.onAuth(userId, db);
                    } else {
                        await signInAnonymously(auth);
                    }
                });
            } catch (e) { console.error("FB Error", e); }
        };

        initFirebase();
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap');

        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: #000;
            overflow: hidden;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            color: white;
        }

        #gameCanvas {
            background: radial-gradient(circle at center, #050510 0%, #000000 100%);
        }

        /* Holographic Glass UI */
        .glass-panel {
            background: rgba(10, 15, 25, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        /* Scanline effect for UI */
        .glass-panel::after {
            content: "";
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, transparent 50%, rgba(0, 0, 0, 0.3) 51%);
            background-size: 100% 4px;
            pointer-events: none;
            opacity: 0.1;
        }

        .game-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; justify-content: center; align-items: center;
            z-index: 20;
        }

        .pointer-auto { pointer-events: auto; }

        .xp-rail {
            position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: rgba(255,255,255,0.05); z-index: 30;
        }
        .xp-fill {
            height: 100%; background: linear-gradient(90deg, #0ea5e9, #6366f1);
            width: 0%; transition: width 0.2s linear;
            box-shadow: 0 0 15px #0ea5e9;
        }

        @keyframes damageFloat {
            0% { transform: translateY(0) scale(1); opacity: 0; }
            10% { transform: translateY(-10px) scale(1.3); opacity: 1; }
            100% { transform: translateY(-40px) scale(0.8); opacity: 0; }
        }
        .dmg-text {
            position: absolute; font-weight: 800; pointer-events: none;
            animation: damageFloat 0.6s ease-out forwards;
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 4px black;
            z-index: 10;
        }

        .title-font { font-family: 'Orbitron', sans-serif; }
        .neon-text { text-shadow: 0 0 10px currentColor; }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        /* Overdrive Button Pulse */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); transform: scale(1); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); transform: scale(1.1); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); transform: scale(1); }
        }
        .animate-pulse-red {
            animation: pulse-red 1.5s infinite;
        }
    </style>
</head>
<body>

    <!-- HUD -->
    <div id="hud" class="hidden absolute inset-0 pointer-events-none z-10">
        <div class="xp-rail"><div id="xpBar" class="xp-fill"></div></div>

        <button id="btnPauseGame" class="pointer-auto absolute top-6 left-1/2 -translate-x-1/2 bg-white/10 backdrop-blur border border-white/20 text-white rounded-full w-12 h-12 flex items-center justify-center hover:bg-white/20 transition-all z-50 text-xl">
            ‚è∏
        </button>

        <!-- Stats -->
        <div class="absolute top-6 left-6 flex flex-col gap-2">
            <div class="glass-panel px-4 py-2 flex items-center gap-3 border-l-2 border-cyan-500">
                <span class="text-xs text-cyan-400 font-bold uppercase tracking-wider title-font">LVL</span>
                <span id="lvlDisplay" class="text-white font-black text-3xl title-font">1</span>
            </div>
            <div class="text-cyan-200 font-mono text-xl pl-1 opacity-80" id="timeDisplay">00:00</div>
        </div>

        <div class="absolute top-6 right-6 flex flex-col items-end gap-2">
            <div class="glass-panel px-4 py-2 text-yellow-400 font-bold border-r-2 border-yellow-500 flex items-center gap-2">
                <span id="goldRunDisplay" class="title-font text-xl">0</span> <span>üíé</span>
            </div>
            
            <!-- HP & Rage Container -->
            <div class="flex flex-col gap-1 items-end">
                <!-- HP -->
                <div class="w-64 h-4 bg-gray-900 border border-gray-700 relative overflow-hidden rounded-sm">
                    <div id="hpBar" class="h-full bg-gradient-to-r from-red-600 to-rose-500 transition-all duration-200" style="width: 100%"></div>
                </div>
                <div class="text-xs font-bold text-gray-500 tracking-widest" id="hpText">100/100</div>

                <!-- Rage Bar -->
                <div class="w-48 h-2 bg-gray-900 border border-gray-700 relative overflow-hidden rounded-sm mt-1">
                    <div id="rageBar" class="h-full bg-gradient-to-r from-orange-500 to-yellow-500 transition-all duration-200" style="width: 0%"></div>
                </div>
                 <div class="text-[9px] font-bold text-orange-500/70 tracking-widest uppercase">Overdrive Charge</div>
            </div>
        </div>

        <!-- Overdrive Button (New Feature) -->
        <div id="btnOverdriveWrapper" class="hidden pointer-auto absolute bottom-36 right-8 z-50">
             <button id="btnOverdrive" class="w-20 h-20 rounded-full bg-red-600/20 border-2 border-red-500 text-white flex items-center justify-center backdrop-blur animate-pulse-red hover:bg-red-600/40 transition-colors">
                <span class="text-4xl filter drop-shadow-[0_0_5px_rgba(255,0,0,0.8)]">üíÄ</span>
            </button>
            <div class="text-center text-red-400 font-black text-xs mt-1 title-font tracking-widest">RAGE</div>
        </div>

        <!-- Dash (Mobile) -->
        <div id="dashBtn" class="pointer-auto absolute bottom-10 right-8 w-24 h-24 rounded-full bg-cyan-500/10 border border-cyan-400/30 flex items-center justify-center backdrop-blur active:scale-95 transition-transform">
            <span class="text-3xl text-cyan-200">‚ö°</span>
            <svg class="absolute w-full h-full -rotate-90 pointer-events-none">
                <circle cx="48" cy="48" r="46" fill="none" stroke="#22d3ee" stroke-width="2" 
                        stroke-dasharray="289" id="dashCircle" stroke-dashoffset="0" style="transition: stroke-dashoffset 0.1s linear"/>
            </svg>
        </div>
    </div>

    <!-- Pause Menu -->
    <div id="pauseScreen" class="game-ui hidden z-50 bg-black/80 backdrop-blur-md pointer-auto">
        <div class="glass-panel p-8 w-80 text-center flex flex-col gap-4 border-t-2 border-white/20">
            <h2 class="text-4xl font-black text-white mb-2 tracking-widest title-font">PAUSED</h2>
            <button id="btnResume" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded transition-all title-font tracking-wider shadow-lg">
                RESUME
            </button>
            <div class="h-px w-full bg-white/10 my-2"></div>
            <button id="btnRetreat" class="bg-emerald-900/80 border border-emerald-500/50 text-emerald-100 hover:bg-emerald-800 font-bold py-4 rounded transition-all title-font tracking-wider shadow-lg flex flex-col items-center justify-center gap-1">
                <span>TACTICAL RETREAT</span>
                <span class="text-[10px] opacity-70 font-sans tracking-normal">End Mission & Keep Loot</span>
            </button>
            <button id="btnExit" class="text-red-400 hover:text-red-300 text-xs font-bold py-2 tracking-wider mt-2">
                SAVE & EXIT (RESUME LATER)
            </button>
        </div>
    </div>

    <!-- Upgrade Screen -->
    <div id="upgradeScreen" class="game-ui hidden z-50 bg-black/90 backdrop-blur-xl pointer-auto">
        <div class="flex flex-col items-center w-full max-w-md p-6 gap-6 h-full justify-center">
            <div class="text-center animate-pulse">
                <h2 class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-amber-500 mb-2 title-font">SYSTEM UPGRADE</h2>
            </div>
            <div id="upgradeCards" class="w-full flex flex-col gap-3"></div>
        </div>
    </div>

    <!-- Main Menu -->
    <div id="mainMenu" class="game-ui z-40 bg-black pointer-auto flex-col overflow-y-auto">
        <div class="absolute inset-0 z-0 bg-[radial-gradient(circle_at_top,_var(--tw-gradient-stops))] from-blue-900/20 via-black to-black"></div>

        <div class="w-full max-w-md p-6 flex flex-col items-center min-h-screen relative pt-16 z-10">
            <!-- Header -->
            <div class="relative mb-12 text-center group">
                <h1 class="text-7xl font-black text-white tracking-tighter title-font text-transparent bg-clip-text bg-gradient-to-b from-cyan-300 to-blue-600 drop-shadow-[0_0_15px_rgba(6,182,212,0.5)]">
                    NEON<br>SURVIVOR
                </h1>
                <div class="text-xs text-gray-500 tracking-[0.6em] mt-4 uppercase border-t border-gray-800 pt-2">Extraction Edition</div>
            </div>

            <!-- Bank -->
            <div class="glass-panel w-full p-6 mb-8 flex justify-between items-center relative overflow-hidden border-l-4 border-yellow-500">
                <div>
                    <div class="text-gray-400 text-[10px] uppercase font-bold tracking-wider mb-1">TOTAL CREDITS</div>
                    <div class="text-yellow-400 font-black text-5xl global-gold-display title-font">...</div>
                </div>
                <div class="text-5xl opacity-80 filter drop-shadow-[0_0_10px_yellow]">üíé</div>
            </div>

            <!-- Actions -->
            <div class="w-full grid gap-4">
                <button id="btnResumeRun" class="hidden bg-emerald-900/50 text-emerald-100 border border-emerald-500/30 font-bold py-5 text-lg tracking-widest uppercase flex items-center justify-center gap-2 shadow-[0_0_20px_rgba(16,185,129,0.1)]">
                    <span>‚ö°</span> Resume Mission
                </button>

                <button id="btnStart" class="bg-blue-700 hover:bg-blue-600 text-white font-black py-6 text-2xl tracking-widest uppercase transition-all shadow-[0_0_30px_rgba(29,78,216,0.3)] title-font relative overflow-hidden group border-t border-white/10">
                    <span class="relative z-10">Deploy Mission</span>
                    <div class="absolute inset-0 bg-white/10 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                </button>

                <div class="grid grid-cols-2 gap-4">
                    <button id="btnShop" class="glass-panel hover:bg-white/5 text-white font-bold py-6 flex flex-col items-center gap-2 border-t-2 border-transparent hover:border-purple-500 transition-colors">
                        <span class="text-3xl filter drop-shadow-[0_0_5px_purple]">üß¨</span>
                        <span class="text-[10px] tracking-widest uppercase">Research</span>
                    </button>
                    <button id="btnHeroes" class="glass-panel hover:bg-white/5 text-white font-bold py-6 flex flex-col items-center gap-2 border-t-2 border-transparent hover:border-pink-500 transition-colors">
                        <span class="text-3xl filter drop-shadow-[0_0_5px_pink]">üë∫</span>
                        <span class="text-[10px] tracking-widest uppercase">Agents</span>
                    </button>
                </div>
            </div>

            <div class="mt-auto pb-6 pt-12 opacity-30 hover:opacity-100 transition-opacity text-center">
                <button onclick="app.resetSave()" class="text-[10px] text-red-500 uppercase tracking-widest border-b border-red-500/30 pb-1">Factory Reset</button>
            </div>
        </div>
    </div>

    <!-- Shop -->
    <div id="shopScreen" class="game-ui hidden z-50 bg-black/95 pointer-auto flex-col backdrop-blur-md">
        <div class="w-full max-w-md p-4 h-full flex flex-col">
            <div class="flex justify-between items-center mb-4 py-4 border-b border-white/10">
                <h2 class="text-2xl font-bold text-white uppercase tracking-wider title-font">Lab</h2>
                <div class="text-yellow-400 font-bold global-gold-display bg-white/5 px-3 py-1 rounded">0</div>
            </div>
            <div id="shopItems" class="space-y-3 overflow-y-auto flex-1 pb-24 scrollbar-hide"></div>
            <button id="btnBackFromShop" class="w-full bg-white/10 text-white font-bold py-4 uppercase tracking-widest hover:bg-white/20 transition-all mb-4 border border-white/10">Back to Base</button>
        </div>
    </div>

    <!-- Heroes -->
    <div id="heroScreen" class="game-ui hidden z-50 bg-black/95 pointer-auto flex-col backdrop-blur-md">
        <div class="w-full max-w-md p-4 h-full flex flex-col">
            <h2 class="text-2xl font-bold text-white mb-4 border-b border-white/10 pb-4 uppercase tracking-wider title-font">Agents</h2>
            <div id="heroGrid" class="grid grid-cols-1 gap-3 overflow-y-auto flex-1 pb-24"></div>
            <button id="btnBackFromHero" class="w-full bg-white/10 text-white font-bold py-4 uppercase tracking-widest hover:bg-white/20 transition-all mb-4 border border-white/10">Back to Base</button>
        </div>
    </div>

    <!-- Game Over (Fail) -->
    <div id="gameOverScreen" class="game-ui hidden z-50 bg-black/90 backdrop-blur-xl pointer-auto flex-col">
        <h2 class="text-7xl font-black text-red-600 mb-2 tracking-tighter title-font drop-shadow-[0_0_15px_red]">K.I.A.</h2>
        <p class="text-red-500 font-mono tracking-[0.5em] text-xs mb-8 uppercase">Signal Lost</p>

        <div class="glass-panel p-8 w-80 text-center mb-8 border-t-4 border-red-600">
            <div class="grid grid-cols-2 gap-8 mb-6 border-b border-white/10 pb-6">
                <div>
                    <div class="text-[10px] text-gray-500 uppercase tracking-widest mb-1">Time</div>
                    <div class="text-white text-2xl font-mono font-bold" id="endStatsTime">00:00</div>
                </div>
                <div>
                    <div class="text-[10px] text-gray-500 uppercase tracking-widest mb-1">Kills</div>
                    <div class="text-white text-2xl font-mono font-bold" id="endStatsKills">0</div>
                </div>
            </div>
            <div>
                <div class="text-[10px] text-gray-500 uppercase mb-2">Loot Secured</div>
                <div class="text-yellow-400 text-5xl font-black flex justify-center items-center gap-3 title-font">
                    <span id="endStatsGold">0</span> <span class="text-3xl">üíé</span>
                </div>
            </div>
        </div>

        <button id="btnRetry" class="bg-white text-black font-black py-4 px-16 hover:scale-105 transition-transform text-xl mb-4 uppercase tracking-widest title-font">Re-Deploy</button>
        <button id="btnHome" class="text-gray-500 hover:text-white transition-colors text-xs tracking-widest uppercase mt-4">Return to Base</button>
    </div>

    <!-- Extraction Success -->
    <div id="extractionScreen" class="game-ui hidden z-50 bg-emerald-950/90 backdrop-blur-xl pointer-auto flex-col">
        <h2 class="text-6xl font-black text-emerald-400 mb-2 tracking-tighter title-font drop-shadow-[0_0_15px_#34d399]">SUCCESS</h2>
        <p class="text-emerald-200 font-mono tracking-[0.5em] text-xs mb-8 uppercase">Extraction Complete</p>

        <div class="glass-panel p-8 w-80 text-center mb-8 border-t-4 border-emerald-500 shadow-[0_0_30px_rgba(16,185,129,0.2)]">
            <div class="mb-6">
                <div class="text-[10px] text-emerald-400/70 uppercase tracking-widest mb-2">Total Loot Secured</div>
                <div class="text-yellow-400 text-6xl font-black flex justify-center items-center gap-3 title-font drop-shadow-md">
                    <span id="extractGold">0</span> <span class="text-3xl">üíé</span>
                </div>
            </div>
            <div class="text-xs text-emerald-300 font-mono">Funds transferred to account.</div>
        </div>

        <button id="btnExtractHome" class="bg-emerald-600 hover:bg-emerald-500 text-white font-black py-4 px-12 rounded transition-all text-xl mb-4 uppercase tracking-widest title-font shadow-lg">
            Return to Base
        </button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script type="module">
        import { doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Config ---
        const HEROES = [
            { id: 'soldier', name: 'COMMANDER', desc: 'Balanced. Heavy Rifle.', cost: 0, hp: 150, speed: 4.5, img: 'üëÆ', color: '#3b82f6', weapon: 'gun' },
            { id: 'tank', name: 'TITAN', desc: 'Tanky. Area Damage.', cost: 3000, hp: 350, speed: 3.5, img: 'ü¶æ', color: '#10b981', weapon: 'orbit' },
            { id: 'ninja', name: 'SPECTRE', desc: 'Fast. High Crit.', cost: 6000, hp: 110, speed: 6.0, img: 'ü•∑', color: '#f43f5e', weapon: 'shuriken' },
            { id: 'mage', name: 'VOLT', desc: 'Auto-Aim Lightning.', cost: 9000, hp: 130, speed: 4.0, img: '‚õàÔ∏è', color: '#8b5cf6', weapon: 'lightning' }
        ];

        const PERM_UPGRADES = {
            damage: { name: 'Kinetic Boost', desc: 'Damage +10%', max: 50, cost: l => 150 + (l * 200), val: l => l * 0.1 }, 
            health: { name: 'Nano Armor', desc: 'Health +20', max: 50, cost: l => 150 + (l * 200), val: l => l * 20 }, 
            speed:  { name: 'Thrusters', desc: 'Speed +3%', max: 20, cost: l => 250 + (l * 250), val: l => l * 0.03 },
            regen:  { name: 'Bio-Repair', desc: 'HP/Sec +0.5', max: 20, cost: l => 350 + (l * 300), val: l => l * 0.5 },
            magnet: { name: 'Loot Range', desc: 'Range +15%', max: 15, cost: l => 200 + (l * 200), val: l => l * 0.15 },
            greed:  { name: 'Crypto Miner', desc: 'Gold Gain +10%', max: 20, cost: l => 300 + (l * 300), val: l => l * 0.1 } 
        };

        const INGAME_UPGRADES = [
            { id: 'multishot', name: 'Split Barrel', desc: '+1 Projectile', rarity: 'rare', color: '#60a5fa' },
            { id: 'dmg', name: 'Hollow Point', desc: 'Damage +25%', rarity: 'common', color: '#f87171' },
            { id: 'haste', name: 'Rapid Fire', desc: 'Fire Rate +20%', rarity: 'common', color: '#fbbf24' },
            { id: 'speed', name: 'Adrenaline', desc: 'Move Speed +10%', rarity: 'common', color: '#34d399' },
            { id: 'orbit', name: 'Plasma Orb', desc: '+1 Protective Orb', rarity: 'epic', color: '#c084fc' },
            { id: 'lightning', name: 'Tesla Coil', desc: 'Zaps nearby enemies', rarity: 'epic', color: '#facc15' },
            { id: 'heal', name: 'Stimpack', desc: 'Heal 50% HP', rarity: 'rare', color: '#f472b6' },
            { id: 'crit', name: 'Targeting Sys', desc: 'Crit Chance +10%', rarity: 'rare', color: '#e879f9' }
        ];

        // --- Engine ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let W, H;

        let Game = {
            state: 'MENU', 
            data: {
                gold: 0,
                unlockedHeroes: ['soldier'],
                upgrades: { damage: 0, health: 0, speed: 0, regen: 0, magnet: 0, greed: 0 },
                selectedHero: 'soldier'
            },
            player: null,
            enemies: [],
            enemyBullets: [],
            bullets: [],
            gems: [],
            particles: [],
            texts: [],
            stars: [],
            time: 0, level: 1, xp: 0, xpNext: 100, kills: 0, runGold: 0,
            spawner: { next: 0 },
            camera: { x: 0, y: 0, shake: 0 },
            input: { active: false, x: 0, y: 0, px: 0, py: 0 },
            rage: 0, // NEW: Current Rage
            rageMax: 100, // NEW: Rage required to activate
            isOverdrive: false, // NEW: State
            overdriveTimer: 0 // NEW: Duration
        };

        // --- Audio ---
        let AudioSys = {
            synth: null,
            init: async () => {
                if(AudioSys.synth) return;
                await Tone.start();
                AudioSys.synth = new Tone.PolySynth(Tone.Synth).toDestination();
                AudioSys.synth.volume.value = -12;
                AudioSys.bass = new Tone.MembraneSynth().toDestination();
                AudioSys.bass.volume.value = -8;
                AudioSys.dist = new Tone.Distortion(0.8).toDestination(); // For Overdrive
            },
            play: (type) => {
                if(!AudioSys.synth) return;
                try {
                    if(type === 'shoot') AudioSys.synth.triggerAttackRelease("C5", "64n", undefined, 0.05);
                    if(type === 'hit') AudioSys.synth.triggerAttackRelease("F2", "32n", undefined, 0.1);
                    if(type === 'coin') AudioSys.synth.triggerAttackRelease("B5", "32n", undefined, 0.05);
                    if(type === 'levelup') AudioSys.synth.triggerAttackRelease(["C4","E4","G4","C5"], "8n");
                    if(type === 'explode') AudioSys.bass.triggerAttackRelease("C1", "16n");
                    if(type === 'dash') AudioSys.bass.triggerAttackRelease("G2", "16n");
                    if(type === 'eshoot') AudioSys.synth.triggerAttackRelease("A2", "64n", undefined, 0.05);
                    if(type === 'success') AudioSys.synth.triggerAttackRelease(["C4","E4","G4","C5","E5"], "4n");
                    if(type === 'overdrive') {
                        AudioSys.bass.triggerAttackRelease("C1", "1n");
                        AudioSys.synth.triggerAttackRelease(["C3","E3","G3"], "2n");
                    }
                } catch(e) {}
            }
        };

        // --- State Management ---
        function updateGlobalUI() {
            const val = Game.data.gold.toLocaleString();
            document.querySelectorAll('.global-gold-display').forEach(el => {
                el.innerText = val;
            });
        }

        function saveProfile() {
            const dataToSave = { 
                gold: Game.data.gold, 
                unlockedHeroes: Game.data.unlockedHeroes, 
                upgrades: Game.data.upgrades, 
                selectedHero: Game.data.selectedHero 
            };
            updateGlobalUI(); 
            if (window.firebaseObj && window.firebaseObj.getUserId()) {
                const ref = doc(window.firebaseObj.db(), `artifacts/${appId}/users/${window.firebaseObj.getUserId()}/data/neon_profile`);
                setDoc(ref, dataToSave, { merge: true });
            } else {
                localStorage.setItem('neon_ext_profile', JSON.stringify(dataToSave));
            }
        }

        function saveCurrentRun() {
            if(Game.state !== 'GAME' && Game.state !== 'PAUSED') return;
            if(Game.player.hp <= 0) return;

            const runData = {
                player: {
                    x: Game.player.x, y: Game.player.y, hp: Game.player.hp, maxHp: Game.player.maxHp,
                    speed: Game.player.speed, weapon: Game.player.weapon, passives: Game.player.passives,
                    magnet: Game.player.magnet, color: Game.player.color, dashCd: Game.player.dashCd,
                    invincible: Game.player.invincible || 0 
                },
                time: Game.time, level: Game.level, xp: Game.xp, xpNext: Game.xpNext,
                kills: Game.kills, runGold: Game.runGold, heroId: Game.data.selectedHero,
                rage: Game.rage // Save rage
            };
            localStorage.setItem('neon_ext_run', JSON.stringify(runData));
        }

        function clearSavedRun() {
            localStorage.removeItem('neon_ext_run');
            updateResumeButton();
        }

        function tacticalRetreat() {
            Game.data.gold += Game.runGold;
            saveProfile();
            clearSavedRun();
            document.getElementById('extractGold').innerText = Game.runGold.toLocaleString();
            setScreen('EXTRACTION');
            AudioSys.play('success');
        }

        // --- NEW FEATURE: Overdrive ---
        function activateOverdrive() {
            if (Game.rage < Game.rageMax || Game.isOverdrive) return;
            Game.isOverdrive = true;
            Game.overdriveTimer = 360; // 6 seconds at 60fps
            Game.rage = 0;
            Game.player.invincible = 360; // Invincible during overdrive
            
            // Visual feedback
            spawnExplosion(Game.player.x, Game.player.y, '#ef4444', 30, true);
            Game.camera.shake = 20;
            AudioSys.play('overdrive');
            
            document.getElementById('btnOverdriveWrapper').classList.add('hidden');
        }

        // --- Initialization ---
        window.app = {
            onAuth: (uid, db) => {
                const ref = doc(db, `artifacts/${appId}/users/${uid}/data/neon_profile`);
                onSnapshot(ref, (snap) => {
                    if (snap.exists()) {
                        Game.data = { ...Game.data, ...snap.data() };
                        if(!Game.data.upgrades) Game.data.upgrades = {};
                        updateGlobalUI();
                    }
                });
            },
            resetSave: () => {
                if(confirm('Warning: This will wipe all progress. Continue?')) {
                    localStorage.clear();
                    location.reload();
                }
            }
        };

        const local = JSON.parse(localStorage.getItem('neon_ext_profile') || 'null');
        if(local) {
            Game.data = { ...Game.data, ...local };
            if(!Game.data.upgrades) Game.data.upgrades = {};
            updateGlobalUI();
        }

        function updateResumeButton() {
            const hasRun = localStorage.getItem('neon_ext_run');
            const btn = document.getElementById('btnResumeRun');
            if(hasRun) btn.classList.remove('hidden');
            else btn.classList.add('hidden');
        }

        function initStars() {
            Game.stars = [];
            for(let i=0; i<120; i++) {
                Game.stars.push({
                    x: Math.random() * W, y: Math.random() * H,
                    size: Math.random() * 2 + 0.5, alpha: Math.random() * 0.5 + 0.1, speed: Math.random() * 0.3 + 0.1
                });
            }
        }

        function init() {
            resize(); initStars();
            window.addEventListener('resize', () => { resize(); initStars(); });
            updateResumeButton();
            updateGlobalUI();

            document.addEventListener('visibilitychange', () => {
                if (document.hidden && Game.state === 'GAME') togglePause();
            });

            const handleStart = (e) => {
                if(Game.state !== 'GAME') return;
                Game.input.active = true;
                const p = e.touches ? e.touches[0] : e;
                Game.input.px = p.clientX; Game.input.py = p.clientY;
                AudioSys.init();
            };
            const handleMove = (e) => {
                if(!Game.input.active) return;
                const p = e.touches ? e.touches[0] : e;
                const dx = p.clientX - Game.input.px;
                const dy = p.clientY - Game.input.py;
                const dist = Math.min(80, Math.sqrt(dx*dx + dy*dy));
                const angle = Math.atan2(dy, dx);
                Game.input.x = Math.cos(angle) * dist;
                Game.input.y = Math.sin(angle) * dist;
            };
            const handleEnd = () => { Game.input.active = false; Game.input.x=0; Game.input.y=0; };

            canvas.addEventListener('mousedown', handleStart);
            canvas.addEventListener('mousemove', handleMove);
            window.addEventListener('mouseup', handleEnd);
            canvas.addEventListener('touchstart', handleStart);
            canvas.addEventListener('touchmove', handleMove);
            window.addEventListener('touchend', handleEnd);

            document.getElementById('btnStart').onclick = () => startGame(false);
            document.getElementById('btnResumeRun').onclick = () => startGame(true);
            document.getElementById('dashBtn').onclick = playerDash;
            document.getElementById('btnShop').onclick = () => { setScreen('SHOP'); renderShop(); };
            document.getElementById('btnHeroes').onclick = () => { setScreen('HEROES'); renderHeroes(); };

            document.getElementById('btnPauseGame').onclick = togglePause;
            document.getElementById('btnResume').onclick = togglePause;
            document.getElementById('btnRetreat').onclick = tacticalRetreat;
            document.getElementById('btnExit').onclick = () => { 
                saveCurrentRun(); 
                setScreen('MENU'); 
                updateResumeButton(); 
            };
            
            // New Feature Button
            document.getElementById('btnOverdrive').onclick = activateOverdrive;

            document.getElementById('btnBackFromShop').onclick = () => setScreen('MENU');
            document.getElementById('btnBackFromHero').onclick = () => setScreen('MENU');
            document.getElementById('btnRetry').onclick = () => startGame(false);
            document.getElementById('btnHome').onclick = () => setScreen('MENU');
            document.getElementById('btnExtractHome').onclick = () => setScreen('MENU');

            requestAnimationFrame(loop);
        }

        function setScreen(screen) {
            Game.state = screen;
            document.querySelectorAll('.game-ui').forEach(el => el.classList.add('hidden'));
            document.getElementById('hud').classList.add('hidden');

            updateGlobalUI(); 

            if(screen === 'MENU') document.getElementById('mainMenu').classList.remove('hidden');
            if(screen === 'GAME') document.getElementById('hud').classList.remove('hidden');
            if(screen === 'PAUSED') {
                document.getElementById('hud').classList.remove('hidden');
                document.getElementById('pauseScreen').classList.remove('hidden');
            }
            if(screen === 'SHOP') document.getElementById('shopScreen').classList.remove('hidden');
            if(screen === 'HEROES') document.getElementById('heroScreen').classList.remove('hidden');
            if(screen === 'GAMEOVER') document.getElementById('gameOverScreen').classList.remove('hidden');
            if(screen === 'EXTRACTION') document.getElementById('extractionScreen').classList.remove('hidden');
            if(screen === 'LEVELUP') document.getElementById('upgradeScreen').classList.remove('hidden');
        }

        function togglePause() {
            if(Game.state === 'GAME') {
                setScreen('PAUSED');
                saveCurrentRun();
            } else if(Game.state === 'PAUSED') {
                setScreen('GAME');
            }
        }

        function startGame(isResume) {
            let savedRun = null;
            if(isResume) {
                try { savedRun = JSON.parse(localStorage.getItem('neon_ext_run')); } catch(e){}
            }

            if(isResume && savedRun) {
                Game.player = { ...savedRun.player, trail: [] };
                if (typeof Game.player.invincible !== 'number') Game.player.invincible = 0;
                Game.time = savedRun.time; Game.level = savedRun.level; Game.xp = savedRun.xp;
                Game.xpNext = savedRun.xpNext; Game.kills = savedRun.kills; Game.runGold = savedRun.runGold;
                Game.data.selectedHero = savedRun.heroId;
                Game.rage = savedRun.rage || 0;
            } else {
                const hero = HEROES.find(h => h.id === Game.data.selectedHero);
                const ups = Game.data.upgrades;

                const maxHp = hero.hp + PERM_UPGRADES.health.val(ups.health || 0);
                const speed = hero.speed * (1 + PERM_UPGRADES.speed.val(ups.speed || 0));
                const dmgMult = 1 + PERM_UPGRADES.damage.val(ups.damage || 0);
                const regen = PERM_UPGRADES.regen.val(ups.regen || 0);
                const magnetBonus = PERM_UPGRADES.magnet.val(ups.magnet || 0);

                Game.player = {
                    x: 0, y: 0,
                    hp: maxHp, maxHp: maxHp,
                    speed: speed,
                    invincible: 60,
                    dashCd: 0,
                    weapon: { 
                        type: hero.weapon, 
                        dmg: 25 * dmgMult, 
                        rate: 22, 
                        count: 1, lastShot: 0, 
                        critChance: 0.10
                    },
                    magnet: 100 * (1 + magnetBonus),
                    passives: { orbit: 0, lightning: 0, regen: regen },
                    color: hero.color,
                    trail: []
                };
                Game.time = 0; Game.level = 1; Game.xp = 0; Game.xpNext = 100;
                Game.runGold = 0; Game.kills = 0;
                Game.rage = 0;
            }
            
            Game.isOverdrive = false;
            Game.overdriveTimer = 0;

            Game.enemies = []; Game.bullets = []; Game.enemyBullets = []; Game.gems = []; Game.particles = []; Game.texts = [];
            Game.spawner = { next: Game.time };

            setScreen('GAME');
            AudioSys.init();
            clearSavedRun(); 
        }

        function loop() {
            requestAnimationFrame(loop);
            if(Game.state !== 'GAME') return;
            const dt = 1/60; Game.time += dt;

            updatePlayer();
            updateWeapons();
            updateEnemies(); 
            updatePhysics();
            render();

            if(Math.floor(Game.time * 60) % 10 === 0) updateHUD();
        }

        function updatePlayer() {
            const p = Game.player;
            let currentSpeed = p.speed;
            
            // Overdrive Logic
            if(Game.isOverdrive) {
                Game.overdriveTimer--;
                currentSpeed *= 1.5; // Faster movement
                if(Game.time % 0.1 < 0.05) spawnExplosion(p.x, p.y, '#ef4444', 1, false); // Aura effect
                if(Game.overdriveTimer <= 0) {
                    Game.isOverdrive = false;
                }
            }

            if(Game.input.active || Game.input.x !== 0) {
                const len = Math.sqrt(Game.input.x**2 + Game.input.y**2);
                if(len > 0) {
                    const factor = len / 80;
                    p.x += (Game.input.x / len) * currentSpeed * factor;
                    p.y += (Game.input.y / len) * currentSpeed * factor;
                }
            }
            if(p.dashCd > 0) p.dashCd--;
            if(p.invincible > 0) p.invincible--;

            if(p.passives.regen > 0 && Game.time % 1 < 0.02) p.hp = Math.min(p.maxHp, p.hp + p.passives.regen);

            if(Game.time % 0.1 < 0.02) p.trail.push({x: p.x, y: p.y, life: 1});
            for(let i=p.trail.length-1; i>=0; i--) {
                p.trail[i].life -= 0.05;
                if(p.trail[i].life <= 0) p.trail.splice(i,1);
            }

            const dashPct = Math.max(0, p.dashCd / 90) * 100;
            const dashC = document.getElementById('dashCircle');
            if(dashC) dashC.style.strokeDashoffset = (289 * dashPct) / 100;
        }

        function playerDash() {
            const p = Game.player;
            if(p.dashCd > 0) return;
            p.dashCd = 90; p.invincible = 45; 
            const angle = Math.atan2(Game.input.y, Game.input.x) || 0;
            p.x += Math.cos(angle) * 180;
            p.y += Math.sin(angle) * 180;
            spawnExplosion(p.x, p.y, '#fff', 15, false); 
            AudioSys.play('dash');
            Game.camera.shake = 8;
        }

        function updateWeapons() {
            const p = Game.player;
            p.weapon.lastShot--;

            if(p.weapon.lastShot <= 0) {
                let target = null, minDist = 360000;
                for(let e of Game.enemies) {
                    const d2 = (e.x - p.x)**2 + (e.y - p.y)**2;
                    if(d2 < minDist) { minDist = d2; target = e; }
                }

                if(target || p.weapon.type === 'shuriken') {
                    const angle = target ? Math.atan2(target.y - p.y, target.x - p.x) : Math.random()*Math.PI*2;
                    for(let i=0; i<p.weapon.count; i++) {
                        const spread = (i - (p.weapon.count-1)/2) * 0.15;
                        Game.bullets.push({ 
                            x: p.x, y: p.y, 
                            vx: Math.cos(angle+spread)*12, vy: Math.sin(angle+spread)*12, 
                            life: 60, 
                            color: Game.isOverdrive ? '#ef4444' : (p.weapon.type === 'lightning' ? '#facc15' : '#00f3ff')
                        });
                    }
                    if(!Game.isOverdrive) AudioSys.play('shoot');
                    // Massive fire rate buff in Overdrive
                    p.weapon.lastShot = Game.isOverdrive ? Math.max(3, p.weapon.rate / 2.5) : p.weapon.rate;
                }
            }

            if(p.passives.orbit > 0) {
                const spd = Game.isOverdrive ? Game.time * 6 : Game.time * 3;
                const count = p.passives.orbit * 2; 
                for(let i=0; i<count; i++) {
                    const a = spd + (i * (Math.PI*2/count));
                    const ox = p.x + Math.cos(a)*120, oy = p.y + Math.sin(a)*120; 
                    for(let e of Game.enemies) {
                        if(Math.hypot(e.x-ox, e.y-oy) < e.size + 25) damageEnemy(e, p.weapon.dmg * 0.4, false);
                    }
                }
            }

            if(p.passives.lightning > 0 && Math.random() < 0.05) { 
                const e = Game.enemies[Math.floor(Math.random()*Game.enemies.length)];
                if(e) {
                    Game.particles.push({type:'lightning', x1:p.x, y1:p.y, x2:e.x, y2:e.y, life:10, color:'#facc15'});
                    damageEnemy(e, p.weapon.dmg * (1 + p.passives.lightning * 0.5), true);
                }
            }
        }

        function updateEnemies() {
            if(Game.enemies.length > 300) return;

            if(Game.time > Game.spawner.next) {
                const minutes = Game.time / 60;
                const factor = (1 + minutes) * Math.pow(1.15, minutes) + (Game.level * 0.15);
                
                const angle = Math.random() * Math.PI * 2;
                const r = Math.max(W, H) / 1.5 + 50;
                const ex = Game.player.x + Math.cos(angle) * r;
                const ey = Game.player.y + Math.sin(angle) * r;

                let type = 'drone', hp = 15 * factor, speed = 1.5 + Math.min(3, factor * 0.1);
                let size = 15, color = '#ef4444', xp = 1;

                const roll = Math.random();
                if(roll < 0.15) { type = 'rusher'; speed *= 2.5; hp *= 0.5; color = '#fbbf24'; } 
                else if(roll < 0.25) { type = 'tank'; speed *= 0.7; hp *= 5; size=28; color = '#818cf8'; xp=5; } 
                else if(roll < 0.4) { type = 'shooter'; speed *= 0.8; hp *= 1.2; color = '#f97316'; xp=3; } 

                const isElite = Math.floor(Game.time) % 60 > 55 && Math.random() < 0.1; 
                if(isElite) {
                    type = 'elite'; hp *= 25; size = 60; speed = 1.8; color = '#9333ea'; xp = 50;
                    Game.texts.push({x:Game.player.x, y:Game.player.y-100, text:"‚ö†Ô∏è ELITE ‚ö†Ô∏è", color:"#9333ea", life:3, vy:0});
                }

                Game.enemies.push({ x: ex, y: ey, hp, maxHp: hp, speed, size, color, xp, type, lastShot: 0 });
                Game.spawner.next = Game.time + Math.max(0.05, 0.8 - (minutes * 0.15));
            }

            for(let i = Game.enemies.length - 1; i >= 0; i--) {
                const e = Game.enemies[i];
                const dx = Game.player.x - e.x;
                const dy = Game.player.y - e.y;
                const distSq = dx*dx + dy*dy;
                
                if (distSq > 4000000) { 
                    Game.enemies.splice(i, 1);
                    continue;
                }

                const dist = Math.sqrt(distSq);
                const angle = Math.atan2(dy, dx);

                if(e.type === 'shooter') {
                    if(dist > 250) {
                        e.x += Math.cos(angle) * e.speed; e.y += Math.sin(angle) * e.speed;
                    } else if (dist < 150) {
                        e.x -= Math.cos(angle) * e.speed * 0.5; e.y -= Math.sin(angle) * e.speed * 0.5;
                    }
                    if(Game.time > e.lastShot && dist < 400) {
                        Game.enemyBullets.push({ x: e.x, y: e.y, vx: Math.cos(angle)*6, vy: Math.sin(angle)*6, life: 100 });
                        e.lastShot = Game.time + 2;
                        AudioSys.play('eshoot');
                    }
                } else {
                    e.x += Math.cos(angle) * e.speed; e.y += Math.sin(angle) * e.speed;
                }

                if(Math.random() < 0.2) { 
                   for(let j=0; j<Game.enemies.length; j++) {
                       if(i===j) continue;
                       const other = Game.enemies[j];
                       const edx = e.x - other.x, edy = e.y - other.y;
                       if(Math.abs(edx) < 30 && Math.abs(edy) < 30) { 
                           e.x += edx * 0.1; e.y += edy * 0.1;
                       }
                   }
                }

                if((Game.player.invincible||0) <= 0) {
                    if(dist < e.size + 15) {
                        Game.player.hp -= 15;
                        Game.player.invincible = 30;
                        Game.camera.shake = 10;
                        AudioSys.play('hit');
                        if(Game.player.hp <= 0) gameOver();
                    }
                }
            }
        }

        function updatePhysics() {
            for(let i=Game.bullets.length-1; i>=0; i--) {
                const b = Game.bullets[i];
                b.x += b.vx; b.y += b.vy; b.life--;
                
                if(b.life <= 0) { Game.bullets.splice(i, 1); continue; }

                for(let e of Game.enemies) {
                    if(Math.hypot(b.x - e.x, b.y - e.y) < e.size + 10) {
                        damageEnemy(e, Game.player.weapon.dmg, true);
                        spawnExplosion(b.x, b.y, b.color, 3, false); 
                        Game.bullets.splice(i, 1);
                        break;
                    }
                }
            }

            for(let i=Game.enemyBullets.length-1; i>=0; i--) {
                const b = Game.enemyBullets[i];
                b.x += b.vx; b.y += b.vy; b.life--;
                if(b.life <= 0) { Game.enemyBullets.splice(i,1); continue; }

                if((Game.player.invincible||0) <= 0) {
                    if(Math.hypot(b.x - Game.player.x, b.y - Game.player.y) < 15) {
                        Game.player.hp -= 10;
                        Game.player.invincible = 30;
                        AudioSys.play('hit');
                        Game.enemyBullets.splice(i, 1);
                        if(Game.player.hp <= 0) gameOver();
                    }
                }
            }

            for(let i=Game.gems.length-1; i>=0; i--) {
                const g = Game.gems[i];
                const distSq = (g.x - Game.player.x)**2 + (g.y - Game.player.y)**2;
                
                if (distSq > 2250000) { 
                    Game.gems.splice(i, 1); 
                    continue; 
                }

                if(distSq < Game.player.magnet**2) {
                    const dist = Math.sqrt(distSq);
                    const pull = 150 / (dist + 10);
                    g.x += (Game.player.x - g.x) * 0.1 * pull;
                    g.y += (Game.player.y - g.y) * 0.1 * pull;
                }

                if(distSq < 900) { 
                    if(g.type === 'gold') {
                        const mult = 1 + PERM_UPGRADES.greed.val(Game.data.upgrades.greed || 0);
                        Game.runGold += Math.max(1, Math.floor(g.val * mult));
                        AudioSys.play('coin');
                        spawnText(g.x, g.y, `+${Math.floor(g.val)}`, '#fbbf24');
                    } else {
                        Game.xp += g.val;
                        if(Game.xp >= Game.xpNext) levelUp();
                    }
                    Game.gems.splice(i, 1);
                }
            }
        }

        function spawnText(x, y, txt, color, isCrit) {
            if(Game.texts.length > 50) Game.texts.shift();
            Game.texts.push({ x, y, text: txt, color, life: 1, vy: -1, isCrit });
        }

        function damageEnemy(e, amt, canCrit) {
            let isCrit = false;
            if(canCrit && Math.random() < (Game.player.weapon.critChance || 0.05)) {
                amt *= 2.0; isCrit = true;
            }
            if(Game.isOverdrive) amt *= 1.5; // Damage boost in Overdrive

            e.hp -= amt;

            if(isCrit || Math.random() > 0.7) {
                spawnText(e.x + (Math.random()*20-10), e.y - 20, Math.floor(amt), isCrit ? '#fbbf24' : '#fff', isCrit);
            }

            if(e.hp <= 0) {
                Game.kills++;
                // Rage Mechanic
                if(!Game.isOverdrive && Game.rage < Game.rageMax) {
                    Game.rage += e.isElite ? 20 : 1;
                    if(Game.rage >= Game.rageMax) Game.rage = Game.rageMax;
                }

                AudioSys.play('explode');
                spawnExplosion(e.x, e.y, e.color, 12, true); 

                const roll = Math.random();
                const isGold = roll > 0.92 || e.isElite; 

                Game.gems.push({ x: e.x, y: e.y, val: isGold ? (e.isElite ? 500 : 10) : e.xp, type: isGold ? 'gold' : 'xp' });

                const idx = Game.enemies.indexOf(e);
                if(idx > -1) Game.enemies.splice(idx, 1);
            }
        }

        function spawnExplosion(x, y, color, count, shockwave) {
            for(let i=0; i<count; i++) {
                const angle = Math.random() * Math.PI * 2;
                const spd = Math.random() * 4 + 2;
                Game.particles.push({
                    x, y, 
                    vx: Math.cos(angle) * spd, 
                    vy: Math.sin(angle) * spd,
                    life: 0.8, 
                    color: color,
                    type: 'spark'
                });
            }
            if(shockwave) {
                Game.particles.push({
                    x, y, radius: 1, maxRadius: 50, life: 1.0, color: color, type: 'shockwave'
                });
            }
        }

        function levelUp() {
            Game.xp -= Game.xpNext;
            Game.xpNext = Math.floor(Game.xpNext * 1.2);
            Game.level++;
            setScreen('LEVELUP');
            AudioSys.play('levelup');

            const div = document.getElementById('upgradeCards');
            div.innerHTML = '';

            const options = [];
            for(let i=0; i<3; i++) options.push(INGAME_UPGRADES[Math.floor(Math.random()*INGAME_UPGRADES.length)]);

            options.forEach(u => {
                const card = document.createElement('div');
                card.className = `glass-panel p-4 rounded-xl flex justify-between items-center cursor-pointer card-anim border-l-4 hover:bg-white/10 transition-colors`;
                card.style.borderLeftColor = u.color;
                card.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-bold text-lg text-white title-font">${u.name}</span>
                        <span class="text-xs text-gray-400">${u.desc}</span>
                    </div>
                    <div class="text-xs font-bold px-2 py-1 rounded bg-gray-800" style="color:${u.color}">${u.rarity.toUpperCase()}</div>
                `;
                card.onclick = () => {
                    applyInGameUpgrade(u);
                    setScreen('GAME');
                    saveCurrentRun();
                };
                div.appendChild(card);
            });
        }

        function applyInGameUpgrade(u) {
            const p = Game.player;
            if(u.id === 'multishot') p.weapon.count++;
            if(u.id === 'dmg') p.weapon.dmg *= 1.25; 
            if(u.id === 'haste') p.weapon.rate = Math.max(5, p.weapon.rate * 0.80); 
            if(u.id === 'speed') p.speed = Math.min(12, p.speed * 1.1);
            if(u.id === 'orbit') p.passives.orbit++;
            if(u.id === 'lightning') p.passives.lightning++;
            if(u.id === 'heal') p.hp = Math.min(p.maxHp, p.hp + p.maxHp * 0.5);
            if(u.id === 'crit') p.weapon.critChance = (p.weapon.critChance || 0.05) + 0.1;
        }

        function render() {
            if(Game.camera.shake > 0) {
                const s = Game.camera.shake;
                ctx.setTransform(1,0,0,1, (Math.random()-0.5)*s, (Math.random()-0.5)*s);
                Game.camera.shake *= 0.9;
                if(Game.camera.shake < 0.5) Game.camera.shake = 0;
            } else {
                ctx.setTransform(1,0,0,1,0,0);
            }

            ctx.fillStyle = '#020205';
            ctx.fillRect(0,0,W,H);

            const p = Game.player;
            const camX = W/2 - p.x;
            const camY = H/2 - p.y;

            Game.stars.forEach(star => {
                let x = (star.x - p.x * star.speed) % W;
                let y = (star.y - p.y * star.speed) % H;
                if(x < 0) x += W;
                if(y < 0) y += H;

                ctx.globalAlpha = star.alpha;
                ctx.fillStyle = '#ffffff';
                ctx.beginPath();
                ctx.arc(x, y, star.size, 0, Math.PI*2);
                ctx.fill();
            });
            ctx.globalAlpha = 1;

            ctx.translate(camX, camY);

            ctx.strokeStyle = '#111827'; ctx.lineWidth = 1;
            const gs = 200;
            const sx = Math.floor((p.x - W/2)/gs)*gs, sy = Math.floor((p.y - H/2)/gs)*gs;
            ctx.beginPath();
            for(let x=sx; x<sx+W+gs; x+=gs) { ctx.moveTo(x, p.y-H); ctx.lineTo(x, p.y+H); }
            for(let y=sy; y<sy+H+gs; y+=gs) { ctx.moveTo(p.x-W, y); ctx.lineTo(p.x+W, y); }
            ctx.stroke();

            ctx.globalCompositeOperation = 'lighter';

            Game.gems.forEach(g => {
                const color = g.type === 'gold' ? '#fbbf24' : '#06b6d4';
                ctx.shadowBlur = 10; ctx.shadowColor = color; ctx.fillStyle = color;
                ctx.beginPath(); ctx.arc(g.x, g.y, 4, 0, Math.PI*2); ctx.fill();
                ctx.shadowBlur = 0;
            });

            p.trail.forEach(t => {
                ctx.globalAlpha = t.life * 0.2; ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(t.x, t.y, 10, 0, Math.PI*2); ctx.fill();
            });
            ctx.globalAlpha = 1;

            ctx.shadowBlur = 25; ctx.shadowColor = p.color; ctx.fillStyle = p.invincible > 0 ? '#fff' : p.color;
            ctx.beginPath(); ctx.arc(p.x, p.y, 16, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = p.color; ctx.lineWidth = 2; ctx.globalAlpha = 0.5 + Math.sin(Game.time * 5) * 0.3;
            ctx.beginPath(); ctx.arc(p.x, p.y, 22, 0, Math.PI*2); ctx.stroke();
            ctx.globalAlpha = 1; ctx.shadowBlur = 0;

            if(p.passives.orbit > 0) {
                const spd = Game.isOverdrive ? Game.time * 6 : Game.time * 3;
                const count = p.passives.orbit * 2;
                for(let i=0; i<count; i++) {
                    const a = spd + (i * (Math.PI*2/count));
                    ctx.shadowBlur=15; ctx.shadowColor='#a855f7'; ctx.fillStyle = '#a855f7'; 
                    ctx.beginPath(); ctx.arc(p.x + Math.cos(a)*120, p.y + Math.sin(a)*120, 6, 0, Math.PI*2); ctx.fill();
                    ctx.shadowBlur=0;
                }
            }

            Game.enemies.forEach(e => {
                ctx.save();
                ctx.translate(e.x, e.y);
                const angle = Math.atan2(p.y - e.y, p.x - e.x);
                ctx.rotate(angle);

                ctx.fillStyle = e.color;
                ctx.shadowBlur = e.isElite ? 30 : 5; 
                ctx.shadowColor = e.color;

                ctx.beginPath();
                ctx.moveTo(e.size/2, 0);
                ctx.lineTo(-e.size/2, -e.size/2);
                ctx.lineTo(-e.size/4, 0);
                ctx.lineTo(-e.size/2, e.size/2);
                ctx.closePath();
                ctx.fill();

                ctx.restore();
            });

            Game.bullets.forEach(b => {
                ctx.shadowBlur = 10; ctx.shadowColor = b.color; ctx.fillStyle = b.color;
                ctx.beginPath(); ctx.arc(b.x, b.y, 3, 0, Math.PI*2); ctx.fill();
            });

            Game.enemyBullets.forEach(b => {
                ctx.shadowBlur = 10; ctx.shadowColor = '#f97316'; ctx.fillStyle = '#f97316';
                ctx.beginPath(); ctx.arc(b.x, b.y, 5, 0, Math.PI*2); ctx.fill();
            });

            ctx.shadowBlur = 0;

            Game.particles.forEach((pt, i) => {
                if(pt.type === 'shockwave') {
                    ctx.strokeStyle = pt.color; ctx.lineWidth = 2 * pt.life; ctx.globalAlpha = pt.life;
                    ctx.beginPath(); ctx.arc(pt.x, pt.y, pt.radius, 0, Math.PI*2); ctx.stroke();
                    pt.radius += (pt.maxRadius - pt.radius) * 0.1; pt.life -= 0.05;
                } else if (pt.type === 'lightning') {
                    ctx.strokeStyle = pt.color; ctx.lineWidth = 2; ctx.globalAlpha = pt.life/10;
                    ctx.shadowBlur = 15; ctx.shadowColor = pt.color;
                    ctx.beginPath(); ctx.moveTo(pt.x1, pt.y1); 
                    const midX = (pt.x1+pt.x2)/2 + (Math.random()-0.5)*30;
                    const midY = (pt.y1+pt.y2)/2 + (Math.random()-0.5)*30;
                    ctx.lineTo(midX, midY); ctx.lineTo(pt.x2, pt.y2); ctx.stroke();
                    pt.life--;
                } else {
                    pt.x += pt.vx; pt.y += pt.vy; pt.life -= 0.06; // Fades faster
                    ctx.globalAlpha = pt.life; ctx.fillStyle = pt.color;
                    ctx.fillRect(pt.x, pt.y, 4, 4);
                }
                if(pt.life <= 0) Game.particles.splice(i, 1);
            });

            ctx.globalCompositeOperation = 'source-over';
            ctx.globalAlpha = 1;

            Game.texts.forEach((t, i) => {
                ctx.fillStyle = t.color;
                ctx.font = t.isCrit ? "900 24px 'Orbitron'" : "700 16px 'Rajdhani'";
                ctx.shadowColor = '#000'; ctx.shadowBlur = 4;
                ctx.fillText(t.text, t.x, t.y);
                t.y += t.vy; t.life -= 0.02;
                if(t.life <= 0) Game.texts.splice(i, 1);
            });
            
            // Overdrive Overlay Effect
            if(Game.isOverdrive) {
                 ctx.fillStyle = `rgba(255, 0, 0, ${0.1 + Math.sin(Game.time * 20) * 0.05})`;
                 ctx.fillRect(0, 0, W, H);
            }

            ctx.setTransform(1,0,0,1,0,0);
        }

        function updateHUD() {
            const hpPct = Math.max(0, (Game.player.hp / Game.player.maxHp) * 100);
            document.getElementById('hpBar').style.width = `${hpPct}%`;
            document.getElementById('hpText').innerText = `${Math.ceil(Game.player.hp)}/${Math.ceil(Game.player.maxHp)}`;
            const xpPct = (Game.xp / Game.xpNext) * 100;
            document.getElementById('xpBar').style.width = `${xpPct}%`;
            document.getElementById('lvlDisplay').innerText = Game.level;
            document.getElementById('goldRunDisplay').innerText = Game.runGold.toLocaleString();
            const m = Math.floor(Game.time / 60);
            const s = Math.floor(Game.time % 60);
            document.getElementById('timeDisplay').innerText = `${m}:${s<10?'0'+s:s}`;
            
            // Rage Bar Update
            const ragePct = Math.min(100, (Game.rage / Game.rageMax) * 100);
            document.getElementById('rageBar').style.width = Game.isOverdrive ? '100%' : `${ragePct}%`;
            
            // Show/Hide Overdrive Button
            const btn = document.getElementById('btnOverdriveWrapper');
            if(Game.rage >= Game.rageMax && !Game.isOverdrive) {
                btn.classList.remove('hidden');
            } else {
                btn.classList.add('hidden');
            }
        }

        function renderShop() {
            const list = document.getElementById('shopItems');
            list.innerHTML = '';
            updateGlobalUI();
            Object.keys(PERM_UPGRADES).forEach(key => {
                const u = PERM_UPGRADES[key];
                const lvl = Game.data.upgrades[key] || 0;
                const cost = u.cost(lvl);
                const isMax = lvl >= u.max;
                const div = document.createElement('div');
                div.className = "glass-panel p-4 rounded-xl flex justify-between items-center border-l-2 border-blue-500 mb-2";
                div.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-white text-lg title-font">${u.name}</span>
                            <span class="text-[10px] bg-blue-900 px-2 py-0.5 rounded text-blue-200">LVL ${lvl}</span>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">${u.desc}</div>
                    </div>
                    <button class="ml-4 px-5 py-3 rounded-lg font-bold text-sm transition-all active:scale-95 border border-white/10 ${Game.data.gold >= cost && !isMax ? 'bg-yellow-600 hover:bg-yellow-500 text-white shadow-lg' : 'bg-gray-800 text-gray-500 cursor-not-allowed'}">
                        ${isMax ? 'MAX' : cost + ' üíé'}
                    </button>
                `;
                if(Game.data.gold >= cost && !isMax) {
                    div.querySelector('button').onclick = () => {
                        Game.data.gold -= cost;
                        Game.data.upgrades[key] = (Game.data.upgrades[key] || 0) + 1;
                        saveProfile();
                        AudioSys.play('coin');
                        renderShop();
                    };
                }
                list.appendChild(div);
            });
        }

        function renderHeroes() {
            const grid = document.getElementById('heroGrid');
            grid.innerHTML = '';
            HEROES.forEach(h => {
                const unlocked = Game.data.unlockedHeroes.includes(h.id);
                const selected = Game.data.selectedHero === h.id;
                const div = document.createElement('div');
                div.className = `glass-panel p-4 rounded-xl flex items-center gap-4 relative cursor-pointer active:scale-95 transition-transform ${selected ? 'border-green-500 bg-green-900/20' : (unlocked ? 'border-gray-700' : 'opacity-60 grayscale')}`;
                div.innerHTML = `
                    <div class="text-4xl bg-black/50 p-3 rounded-full border border-white/10">${h.img}</div>
                    <div class="flex-1">
                        <div class="font-black text-white text-lg title-font tracking-wide">${h.name}</div>
                        <div class="text-xs text-gray-400">${h.desc}</div>
                    </div>
                    <div>
                         ${!unlocked 
                            ? `<button class="bg-yellow-600 text-white font-bold px-4 py-2 rounded-lg text-sm shadow-lg">${h.cost} üíé</button>` 
                            : (selected 
                                ? '<div class="text-green-400 font-bold text-xs border border-green-500 px-2 py-1 rounded tracking-widest">ACTIVE</div>' 
                                : '<div class="text-gray-500 text-xs border border-gray-600 px-2 py-1 rounded tracking-widest">SELECT</div>')}
                    </div>
                `;
                div.onclick = () => {
                    if(unlocked) {
                        Game.data.selectedHero = h.id;
                        saveProfile();
                        renderHeroes();
                    } else if(Game.data.gold >= h.cost) {
                        Game.data.gold -= h.cost;
                        Game.data.unlockedHeroes.push(h.id);
                        Game.data.selectedHero = h.id;
                        saveProfile();
                        AudioSys.play('coin');
                        renderHeroes();
                    }
                };
                grid.appendChild(div);
            });
        }

        function gameOver() {
            setScreen('GAMEOVER');
            clearSavedRun();
            Game.data.gold += Game.runGold;
            saveProfile();
            document.getElementById('endStatsTime').innerText = document.getElementById('timeDisplay').innerText;
            document.getElementById('endStatsKills').innerText = Game.kills;
            document.getElementById('endStatsGold').innerText = Game.runGold.toLocaleString();
        }

        function resize() { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; }

        window.onload = init;
    </script>
</body>
</html>